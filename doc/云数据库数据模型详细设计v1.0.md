# 轨迹 App 云数据库（AGC Cloud DB）数据模型详细设计 V1.0

> 依据《技术架构文档v1.0》《需求文档v1.0》编写，用于在 AGC 控制台创建 Cloud DB 对象类型（Object Type）。  
> 字段类型以 AGC Cloud DB 支持为准：String、Integer、Long、Float、Double、Boolean、Date、Text、ByteArray 等。  
> **V1.0 模型说明**：一条轨迹不拆分多段，仅包含起点、若干打卡点（墓地点）、终点；支持暂停/继续记录。  
> **GPS 数据本地优先存储**：所有轨迹点等 GPS 信息优先写入本地（RDB），网络良好时再同步到云端。

---

## 开发前期：先建云库 + 先存本地再上传

### 1. 开发顺序建议

| 阶段 | 做什么 | 说明 |
|------|--------|------|
| **第一步** | **在 AGC 控制台建立云数据库** | 按本文「三、对象类型详细定义」在 Cloud DB 中创建对象类型：User、Track、TrackPoint、TombSpot、Post；发布后客户端才能按同一模型读写（V1.0 不再使用 TrackSegment）。 |
| **第二步** | **本地存储与云库模型一致** | 本地（RDB / Preference / 内存）使用的数据结构、字段名、类型与云库对象类型一一对应或可映射，便于「先写本地 → 有网再上传」。本地表增加 `syncStatus` 字段标记同步状态。 |
| **第三步** | **先实现「只写本地」** | 轨迹记录、打卡点（墓地点）、图文等**先落本地库**；无网或弱网时仅操作本地，保证山上记录不丢。**GPS 数据本地优先存储为核心策略，不仅是弱网降级。** |
| **第四步** | **再实现「上传/同步」** | 网络恢复或合适时机（如设置打卡点、结束轨迹、进入首页时）将本地未同步数据（`syncStatus = pending`）上传到 Cloud DB / Cloud Storage。 |

### 2. 技术方案：先存本地，再上传

- **写操作**：用户创建/编辑轨迹、段、点、墓地点、图文时，**先写入本地**（鸿蒙 RDB 或结构化本地存储）；上传作为后续步骤，成功后标记 `syncStatus = synced` 或从本地待同步队列移除。
- **读操作**：  
  - 有网且已同步：可直接查 Cloud DB（或先查本地缓存再按需刷新）。  
  - 无网或优先看本地：只读本地，列表与详情均来自本地；有网后再在后台拉取云端并合并。
- **上传时机（建议）**：  
  - 设置打卡点 → 将新增 TrackPoint 及该 TombSpot 上传（若有网）；  
  - 结束轨迹 → 将 Track 状态改为 done，并上传/更新 Track（含起点名、终点名）及所有未同步的轨迹点；  
  - 保存打卡点图文 → 图片先传 Cloud Storage 拿 URL，再与 Post/TombSpot 一起写 Cloud DB（若有网）；  
  - App 从后台回到前台或进入「我的轨迹」时 → 检查网络，若有网则上传本地 `syncStatus = pending` 的数据。
- **冲突与顺序**：V1.0 建议以「本地为准、后写覆盖」的简单策略为主；同一轨迹/段由同一设备创建，避免多端同时写导致复杂冲突。

### 3. 本地存储与云库的对应关系

| 云库对象类型 | 本地存储建议 | 说明 |
|--------------|--------------|------|
| User | Preference 或 RDB 单表 | 当前用户信息；**首次鸿蒙授权登录后自动创建记录**，可从 Cloud DB 拉取一份存本地，离线展示用。 |
| Track | RDB 表，字段与 Cloud DB Track 一致 | 主键 trackId；含 startName、endName；增加字段 `syncStatus`（pending/synced）便于上传队列。 |
| TrackPoint | RDB 表，字段与 Cloud DB 一致 | 直接关联 trackId，按 orderIndex 排序；**GPS 数据本地优先存储**，增加 `syncStatus` 字段；一条轨迹一条连续点序列（暂停/继续会产生时间间隙）。 |
| TombSpot | RDB 表，字段与 Cloud DB 一致 | 直接关联 trackId，按 orderIndex 排序；每个打卡点即一个墓地点；**创建人可修改 name 字段（打卡点名称）**，修改后需同步更新云端。 |
| Post | RDB 表，字段与 Cloud DB 一致 | imageUrls 存 JSON 字符串；图片先落本地路径，上传后替换为 Cloud Storage URL 再写云。 |

**要点**：本地表结构（字段名、类型）与云库对象类型保持一致，上传时即可按条/按批映射写入 Cloud DB，无需再做复杂转换。

### 4. 开发前期你需要完成的事（小结）

1. **在 AGC 控制台**：创建 Cloud DB，按本文第三节创建并发布 **User、Track、TrackPoint、TombSpot、Post** 共 5 个对象类型及索引（V1.0 不使用 TrackSegment）。  
2. **在工程内**：  
   - 定义与云库同构的本地模型（ArkTS interface/class 或 RDB 表结构），本地表增加 `syncStatus` 字段。  
   - 先实现「只写本地」的增删改查（**GPS 数据本地优先存储**）。  
   - 再实现「检测网络 → 上传待同步数据到 Cloud DB / Cloud Storage」的逻辑。

按上述顺序，即可在开发前期先建立云数据库，并采用「先存本地再上传」的技术方案推进。

---

## 一、对象类型总览

| 序号 | 对象类型名称 | 说明 | V1.0 是否创建 |
|------|--------------|------|----------------|
| 1 | User | 用户基本信息（**首次授权登录自动创建**） | ✅ 是 |
| 2 | Track | 一条完整扫墓轨迹（起点、若干打卡点、终点；支持暂停/继续） | ✅ 是 |
| 3 | TrackPoint | 轨迹点（直接关联 Track，GPS+海拔+顺序；**本地优先存储**） | ✅ 是 |
| 4 | TombSpot | 打卡点（墓地点）信息（直接关联 Track，按顺序；**创建人可修改名称**） | ✅ 是 |
| 5 | Post | 打卡点图文内容 | ✅ 是 |
| 6 | Comment | 评论 | ❌ V2.0 |
| 7 | FamilyMember | 家庭空间成员 | ❌ V2.0 |

---

## 二、枚举与常量（供字段取值参考）

| 枚举 | 取值 | 说明 |
|------|------|------|
| **Track.visibility** | `PUBLIC` | 公开，所有用户可见 |
| | `PRIVATE` | 私有，仅创建人可见 |
| | `FAMILY` | 家庭可见（V2.0 再启用） |
| **Track.status** | `editing` | 编辑中，未完成 |
| | `done` | 已完成，对外可见 |

---

## 三、对象类型详细定义

### 3.1 User（用户）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| userId | String | ✅ | ✅ | — | 用户唯一标识，与 AGC Auth 返回的 UID 一致 |
| phone | String | — | — | — | 手机号（V1.0 可不填，预留） |
| nickname | String | — | — | — | 昵称 |
| avatarUrl | String | — | — | — | 头像 URL（Cloud Storage 地址） |
| familyName | String | — | — | — | 所属家族/姓氏（如「刘氏」） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `userId`。  
**说明**：**首次鸿蒙授权登录后，由客户端检查 User 表是否已有该 userId 的记录；若无，则自动创建一条 User 记录**（userId 取 AGC Auth 返回的 UID，昵称和头像可从鸿蒙账号信息获取或由用户后续完善），确保每个登录用户在用户列表中都有对应记录。与 AGC Auth 用户一一对应。

---

### 3.2 Track（轨迹）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| trackId | String | ✅ | ✅ | — | 轨迹唯一 ID（建议客户端生成 UUID） |
| ownerUserId | String | — | ✅ | — | 创建人 userId，关联 User.userId |
| title | String | — | ✅ | — | 轨迹名称 |
| description | String | — | — | — | 轨迹简介 |
| startName | String | — | — | — | 起点名称（如「山脚入口」） |
| endName | String | — | — | — | 终点名称（如「山脚出口」） |
| visibility | String | — | ✅ | `PRIVATE` | 可见范围：PUBLIC / PRIVATE（FAMILY 留 V2.0） |
| status | String | — | ✅ | `editing` | 状态：editing / done |
| coverImageUrl | String | — | — | — | 封面图 URL（可选，用于列表展示） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |
| totalDistance | Double | — | — | — | 总里程（米），记录结束时写入，便于列表展示与恢复 |
| totalDuration | Long | — | — | — | 总用时（毫秒），记录结束时写入，便于列表展示与恢复 |
| maxAltitude | Double | — | — | — | 最高海拔（米），记录过程中更新 |
| startLat | Double | — | — | — | 起点纬度 |
| startLng | Double | — | — | — | 起点经度 |
| endLat | Double | — | — | — | 终点纬度 |
| endLng | Double | — | — | — | 终点经度 |

**索引建议**：主键 `trackId`；建议为 `ownerUserId`、`visibility`、`createdAt` 建索引，便于「我的轨迹」与「公开轨迹列表」查询。

**说明**：一条轨迹仅一条连续路径，含起点、若干打卡点（墓地点）、终点；支持暂停/继续记录。V1.0 不再使用"轨迹段（Segment）"概念。**totalDistance、totalDuration、maxAltitude 及起终点坐标**在记录过程中或结束轨迹时写入，用于列表展示及卸载重装后从云端恢复。

**查询示例**：
- 我的轨迹：`ownerUserId == 当前用户ID`，按 `createdAt` 倒序。
- 公开轨迹列表：`visibility == "PUBLIC"` 且 `status == "done"`，按 `createdAt` 倒序。

---

### 3.3 TrackPoint（轨迹点）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| pointId | String | ✅ | ✅ | — | 轨迹点唯一 ID |
| trackId | String | — | ✅ | — | 所属轨迹 ID，关联 Track.trackId |
| orderIndex | Integer | — | ✅ | — | 点在该轨迹内的序号（从 0 起） |
| lat | Double | — | ✅ | — | 纬度 |
| lng | Double | — | ✅ | — | 经度 |
| altitude | Double | — | — | — | 海拔（米） |
| accuracy | Float | — | — | — | 精度（米，可选） |
| timestamp | Long | — | — | — | 采集时间戳（毫秒） |
| createdAt | Date | — | — | — | 写入云端时间（可选） |

**索引建议**：主键 `pointId`；建议为 `trackId` + `orderIndex` 建索引，便于按轨迹拉取点序列画线。

**说明**：一条轨迹一条连续点序列，直接关联 Track；暂停/继续会产生时间上的间隙，顺序仍按 orderIndex 排列。**GPS 数据本地优先存储**：轨迹点在采集时必须先写入本地 RDB，本地表增加 `syncStatus`（pending/synced）字段标记同步状态，网络良好时批量上传到 Cloud DB。**数据量控制**：写入云库的轨迹点应为经「采集端采样 + 上传前抽稀」后的点集（详见《技术架构文档v1.0》3.1 节），单条轨迹建议将点数控制在合理范围（如数百至约一两千点），以降低存储与查询成本；可考虑批量写入、查询时按 trackId 拉取。

---

### 3.4 TombSpot（打卡点/墓地点）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| tombId | String | ✅ | ✅ | — | 打卡点（墓地点）唯一 ID |
| trackId | String | — | ✅ | — | 所属轨迹 ID，关联 Track.trackId |
| orderIndex | Integer | — | ✅ | — | 打卡点在该轨迹内的顺序（从 0 起） |
| name | String | — | ✅ | — | 打卡点名称（如「祖父某某之墓」），**创建人可修改** |
| personInfo | String | — | — | — | 人物信息（姓氏、辈分、称呼、去世年代等，可 JSON 或纯文本） |
| remark | String | — | — | — | 备注 |
| lat | Double | — | — | — | 纬度 |
| lng | Double | — | — | — | 经度 |
| altitude | Double | — | — | — | 海拔（米） |
| contentText | Text | — | — | — | 打卡点图文文字内容（详情页编辑后同步，便于单表展示与云端恢复） |
| imageUris | Text | — | — | — | 打卡点图片 URL 列表，JSON 数组字符串，如 `["url1","url2"]`，对应 Cloud Storage 地址；与 Post 可并存，V1.0 存于 TombSpot 便于恢复与展示 |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `tombId`；建议为 `trackId`、`orderIndex` 建索引。

**说明**：V1.0 中每条轨迹有若干打卡点（TombSpot），每个打卡点即一个墓地点；打卡点详情页（P1-5）展示本表 + 该 tombId 下的 Post 列表。**仅轨迹创建人可修改打卡点名称（name 字段）**，修改后需更新 `updatedAt` 并同步到云端。**contentText、imageUris** 在详情页编辑后写入，用于卸载重装后从云端恢复打卡点图文与图片。

---

### 3.5 Post（打卡点图文）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| postId | String | ✅ | ✅ | — | 图文记录唯一 ID |
| tombId | String | — | ✅ | — | 所属打卡点（墓地点）ID，关联 TombSpot.tombId |
| trackId | String | — | ✅ | — | 所属轨迹 ID，便于按轨迹筛图文 |
| authorUserId | String | — | ✅ | — | 作者 userId，关联 User.userId |
| contentText | Text | — | — | — | 文字内容（长文本用 Text） |
| imageUrls | Text | — | — | — | 图片 URL 列表，JSON 数组字符串，如 `["url1","url2"]`，对应 Cloud Storage 地址 |
| isPinned | Boolean | — | — | false | 是否置顶（V1.0 可忽略，V2.0 再用于排序） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `postId`；建议为 `tombId`、`trackId`、`authorUserId` 建索引。

**说明**：仅轨迹创建人可写；imageUrls 存 Cloud Storage 返回的 URL，多条用 JSON 数组存储。

---

### 3.6 Comment（评论）— V2.0 再创建

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| commentId | String | ✅ | ✅ | — | 评论唯一 ID |
| postId | String | — | ✅ | — | 所属图文 ID |
| authorUserId | String | — | ✅ | — | 评论人 userId |
| contentText | Text | — | ✅ | — | 评论内容 |
| createdAt | Date | — | — | — | 创建时间 |

**说明**：V1.0 不实现，上表供 V2.0 在 Cloud DB 中创建对象类型时参考。

---

### 3.7 FamilyMember（家庭空间成员）— V2.0 再创建

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| id | String | ✅ | ✅ | — | 主键 |
| trackId | String | — | ✅ | — | 关联轨迹/家庭空间（或改为 familyId） |
| userId | String | — | ✅ | — | 成员 userId |
| role | String | — | ✅ | — | 角色：owner / admin / member |
| joinedAt | Date | — | — | — | 加入时间 |

**说明**：V1.0 不实现，上表供 V2.0 在 Cloud DB 中创建对象类型时参考。

---

## 四、实体关系简图（V1.0）

```
User (userId)  ← 首次授权登录自动创建
  │
  ├── 1:N → Track (ownerUserId)
  │           │
  │           ├── 1:N → TrackPoint (trackId)  一条轨迹一条连续点序列（本地优先存储）
  │           └── 1:N → TombSpot (trackId)    一条轨迹若干打卡点（创建人可改名称）
  │
  └── 1:N → Post (authorUserId)

TombSpot (tombId) ──1:N──→ Post (tombId)
```

---

## 五、在 AGC 控制台创建对象类型的步骤建议

1. 登录 [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html) → 您的项目 → **构建** → **云数据库**。
2. 在 **对象类型** 中依次新建：**User、Track、TrackPoint、TombSpot、Post**（Comment、FamilyMember 留 V2.0）。V1.0 不使用 TrackSegment。
3. 每个对象类型下，按上表添加字段：选择 **字段类型**（String/Integer/Long/Double/Float/Boolean/Date/Text 等），勾选主键、非空、默认值（若支持）。
4. 为常用查询条件字段设置 **索引**（如 Track 的 ownerUserId、visibility、createdAt；TrackPoint 的 trackId、orderIndex；TombSpot 的 trackId、orderIndex；Post 的 tombId、trackId）。
5. 发布对象类型后，在客户端集成 Cloud DB SDK，并生成或手写与上述字段一致的本地模型类（如 ArkTS 的 interface/class），保证读写字段一致。

---

## 六、Cloud Storage 路径建议（与数据模型配合）

| 用途 | 建议路径示例 | 说明 |
|------|--------------|------|
| 用户头像 | `users/{userId}/avatar.{ext}` | 按用户隔离 |
| 轨迹封面 | `tracks/{trackId}/cover.{ext}` | 可选 |
| 墓地点图片 | `tracks/{trackId}/tombs/{tombId}/posts/{postId}/{index}.{ext}` | 与 Post.imageUrls 对应 |
| 分享海报 | `tracks/{trackId}/share.{ext}` | 生成后上传 |

---

## 七、客户端 schema.json 与 AGC 控制台一致（必做）

工程内 `entry/src/main/resources/rawfile/schema.json` 必须与 **AGC 控制台** 里 Cloud DB 的对象类型、字段名、类型、主键一致，否则重装恢复或同步会异常（例如查不到 contentText/imageUris、upsert 报错等）。

**重点检查：**

1. **TombSpot**：必须有 `contentText`（Text）、`imageUris`（Text），用于打卡点图文与图片（V1.0 不使用 segmentId，无需该字段）。
2. **Track**：若有 `totalDistance`、`totalDuration`、`maxAltitude`、起终点坐标等，需与本文第三节一致。
3. **schemaVersion**：与在控制台发布的对象类型版本一致；若在控制台新增/改字段，需同步更新 schema.json 并保证客户端与服务器一致。

以上内容可直接用于在 AGC 云数据库中创建对象类型及字段；若控制台字段类型名称与本文略有差异（如 Int vs Integer），以控制台为准。

# 轨迹 App 云数据库（AGC Cloud DB）数据模型详细设计 V1.0

> 依据《技术架构文档v1.0》《需求文档v1.0》编写，用于在 AGC 控制台创建 Cloud DB 对象类型（Object Type）。  
> 字段类型以 AGC Cloud DB 支持为准：String、Integer、Long、Float、Double、Boolean、Date、Text、ByteArray 等。

---

## 开发前期：先建云库 + 先存本地再上传

### 1. 开发顺序建议

| 阶段 | 做什么 | 说明 |
|------|--------|------|
| **第一步** | **在 AGC 控制台建立云数据库** | 按本文「三、对象类型详细定义」在 Cloud DB 中创建对象类型：User、Track、TrackSegment、TrackPoint、TombSpot、Post；发布后客户端才能按同一模型读写。 |
| **第二步** | **本地存储与云库模型一致** | 本地（RDB / Preference / 内存）使用的数据结构、字段名、类型与云库对象类型一一对应或可映射，便于「先写本地 → 有网再上传」。 |
| **第三步** | **先实现「只写本地」** | 轨迹记录、墓地点、图文等先落本地库；无网或弱网时仅操作本地，保证山上记录不丢。 |
| **第四步** | **再实现「上传/同步」** | 网络恢复或合适时机（如结束一段、结束整条轨迹、进入首页时）将本地未同步数据上传到 Cloud DB / Cloud Storage。 |

### 2. 技术方案：先存本地，再上传

- **写操作**：用户创建/编辑轨迹、段、点、墓地点、图文时，**先写入本地**（鸿蒙 RDB 或结构化本地存储）；上传作为后续步骤，成功后可标记「已同步」或从本地待同步队列移除。
- **读操作**：  
  - 有网且已同步：可直接查 Cloud DB（或先查本地缓存再按需刷新）。  
  - 无网或优先看本地：只读本地，列表与详情均来自本地；有网后再在后台拉取云端并合并。
- **上传时机（建议）**：  
  - 结束本段轨迹 → 将该段 TrackSegment + 本段 TrackPoint 批量上传；  
  - 结束整条轨迹 → 将 Track 状态改为 done，并上传/更新 Track；  
  - 保存墓地点/图文 → 图片先传 Cloud Storage 拿 URL，再与 Post/TombSpot 一起写 Cloud DB；  
  - App 从后台回到前台或进入「我的轨迹」时 → 检查网络，若有网则上传本地「未同步」数据。
- **冲突与顺序**：V1.0 建议以「本地为准、后写覆盖」的简单策略为主；同一轨迹/段由同一设备创建，避免多端同时写导致复杂冲突。

### 3. 本地存储与云库的对应关系

| 云库对象类型 | 本地存储建议 | 说明 |
|--------------|--------------|------|
| User | Preference 或 RDB 单表 | 当前用户信息；登录后可从 Cloud DB 拉取一份存本地，离线展示用。 |
| Track | RDB 表，字段与 Cloud DB Track 一致 | 主键 trackId；增加字段如 `syncStatus`（pending/synced）便于上传队列。 |
| TrackSegment | RDB 表，字段与 Cloud DB 一致 | 主键 segmentId，外键 trackId；同上可加 syncStatus。 |
| TrackPoint | RDB 表，字段与 Cloud DB 一致 | 单段可能很多点，按 segmentId 分表或加索引；结束段时批量上传。 |
| TombSpot | RDB 表，字段与 Cloud DB 一致 | 与段一一对应，可与 Segment 同批上传。 |
| Post | RDB 表，字段与 Cloud DB 一致 | imageUrls 存 JSON 字符串；图片先落本地路径，上传后替换为 Cloud Storage URL 再写云。 |

**要点**：本地表结构（字段名、类型）与云库对象类型保持一致，上传时即可按条/按批映射写入 Cloud DB，无需再做复杂转换。

### 4. 开发前期你需要完成的事（小结）

1. **在 AGC 控制台**：创建 Cloud DB，按本文第三节创建并发布 **User、Track、TrackSegment、TrackPoint、TombSpot、Post** 共 6 个对象类型及索引。  
2. **在工程内**：  
   - 定义与云库同构的本地模型（ArkTS interface/class 或 RDB 表结构）。  
   - 先实现「只写本地」的增删改查。  
   - 再实现「检测网络 → 上传待同步数据到 Cloud DB / Cloud Storage」的逻辑。

按上述顺序，即可在开发前期先建立云数据库，并采用「先存本地再上传」的技术方案推进。

---

## 一、对象类型总览

| 序号 | 对象类型名称 | 说明 | V1.0 是否创建 |
|------|--------------|------|----------------|
| 1 | User | 用户基本信息 | ✅ 是 |
| 2 | Track | 一条完整扫墓轨迹 | ✅ 是 |
| 3 | TrackSegment | 轨迹段（起点/终点为界） | ✅ 是 |
| 4 | TrackPoint | 轨迹点（GPS+海拔） | ✅ 是 |
| 5 | TombSpot | 墓地点信息（与段终点对应） | ✅ 是 |
| 6 | Post | 墓地点图文内容 | ✅ 是 |
| 7 | Comment | 评论 | ❌ V2.0 |
| 8 | FamilyMember | 家庭空间成员 | ❌ V2.0 |

---

## 二、枚举与常量（供字段取值参考）

| 枚举 | 取值 | 说明 |
|------|------|------|
| **Track.visibility** | `PUBLIC` | 公开，所有用户可见 |
| | `PRIVATE` | 私有，仅创建人可见 |
| | `FAMILY` | 家庭可见（V2.0 再启用） |
| **Track.status** | `editing` | 编辑中，未完成 |
| | `done` | 已完成，对外可见 |

---

## 三、对象类型详细定义

### 3.1 User（用户）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| userId | String | ✅ | ✅ | — | 用户唯一标识，与 AGC Auth 返回的 UID 一致 |
| phone | String | — | — | — | 手机号（V1.0 可不填，预留） |
| nickname | String | — | — | — | 昵称 |
| avatarUrl | String | — | — | — | 头像 URL（Cloud Storage 地址） |
| familyName | String | — | — | — | 所属家族/姓氏（如「刘氏」） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `userId`。  
**说明**：首次鸿蒙账号登录后由客户端或云函数创建/更新本条记录，与 AGC Auth 用户一一对应。

---

### 3.2 Track（轨迹）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| trackId | String | ✅ | ✅ | — | 轨迹唯一 ID（建议客户端生成 UUID） |
| ownerUserId | String | — | ✅ | — | 创建人 userId，关联 User.userId |
| title | String | — | ✅ | — | 轨迹名称 |
| description | String | — | — | — | 轨迹简介 |
| visibility | String | — | ✅ | `PRIVATE` | 可见范围：PUBLIC / PRIVATE（FAMILY 留 V2.0） |
| status | String | — | ✅ | `editing` | 状态：editing / done |
| coverImageUrl | String | — | — | — | 封面图 URL（可选，用于列表展示） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `trackId`；建议为 `ownerUserId`、`visibility`、`createdAt` 建索引，便于「我的轨迹」与「公开轨迹列表」查询。

**查询示例**：
- 我的轨迹：`ownerUserId == 当前用户ID`，按 `createdAt` 倒序。
- 公开轨迹列表：`visibility == "PUBLIC"` 且 `status == "done"`，按 `createdAt` 倒序。

---

### 3.3 TrackSegment（轨迹段）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| segmentId | String | ✅ | ✅ | — | 轨迹段唯一 ID |
| trackId | String | — | ✅ | — | 所属轨迹 ID，关联 Track.trackId |
| orderIndex | Integer | — | ✅ | — | 段序号（从 0 起），用于排序 |
| startName | String | — | — | — | 起点名称（如「山脚入口」） |
| endName | String | — | — | — | 终点名称（如「xx 祖墓」） |
| startLat | Double | — | — | — | 起点纬度（矫正后） |
| startLng | Double | — | — | — | 起点经度 |
| startAltitude | Double | — | — | — | 起点海拔（米） |
| endLat | Double | — | — | — | 终点纬度 |
| endLng | Double | — | — | — | 终点经度 |
| endAltitude | Double | — | — | — | 终点海拔（米） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `segmentId`；建议为 `trackId`、`orderIndex` 建索引，便于按轨迹查分段列表。

**说明**：一段轨迹对应一条 TrackSegment；起点/终点坐标可与该段首末 TrackPoint 一致，支持后续矫正（FR-MNG-007）。

---

### 3.4 TrackPoint（轨迹点）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| pointId | String | ✅ | ✅ | — | 轨迹点唯一 ID |
| segmentId | String | — | ✅ | — | 所属轨迹段 ID，关联 TrackSegment.segmentId |
| orderIndex | Integer | — | ✅ | — | 点在该段内的序号（从 0 起） |
| lat | Double | — | ✅ | — | 纬度 |
| lng | Double | — | ✅ | — | 经度 |
| altitude | Double | — | — | — | 海拔（米） |
| accuracy | Float | — | — | — | 精度（米，可选） |
| timestamp | Long | — | — | — | 采集时间戳（毫秒） |
| createdAt | Date | — | — | — | 写入云端时间（可选） |

**索引建议**：主键 `pointId`；建议为 `segmentId` + `orderIndex` 建索引，便于按段拉取点序列画线。

**说明**：单段可能包含大量点，可考虑按段批量写入、查询时按 segmentId 拉取；后续可在云函数中做抽稀/压缩。

---

### 3.5 TombSpot（墓地点）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| tombId | String | ✅ | ✅ | — | 墓地点唯一 ID |
| segmentId | String | — | ✅ | — | 对应轨迹段 ID（一段终点对应一个墓地点） |
| trackId | String | — | ✅ | — | 所属轨迹 ID，便于按轨迹查墓地点 |
| name | String | — | ✅ | — | 墓地点名称（如「祖父某某之墓」） |
| personInfo | String | — | — | — | 人物信息（姓氏、辈分、称呼、去世年代等，可 JSON 或纯文本） |
| remark | String | — | — | — | 备注 |
| lat | Double | — | — | — | 纬度（可与段终点一致） |
| lng | Double | — | — | — | 经度 |
| altitude | Double | — | — | — | 海拔（米） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `tombId`；建议为 `segmentId`、`trackId` 建索引。

**说明**：V1.0 中一个 TrackSegment 的终点对应一个 TombSpot；墓地点详情页（P1-5）展示本表 + 该 tombId 下的 Post 列表。

---

### 3.6 Post（墓地点图文）

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| postId | String | ✅ | ✅ | — | 图文记录唯一 ID |
| tombId | String | — | ✅ | — | 所属墓地点 ID，关联 TombSpot.tombId |
| trackId | String | — | ✅ | — | 所属轨迹 ID，便于按轨迹筛图文 |
| authorUserId | String | — | ✅ | — | 作者 userId，关联 User.userId |
| contentText | Text | — | — | — | 文字内容（长文本用 Text） |
| imageUrls | Text | — | — | — | 图片 URL 列表，JSON 数组字符串，如 `["url1","url2"]`，对应 Cloud Storage 地址 |
| isPinned | Boolean | — | — | false | 是否置顶（V1.0 可忽略，V2.0 再用于排序） |
| createdAt | Date | — | — | — | 创建时间 |
| updatedAt | Date | — | — | — | 更新时间 |

**索引建议**：主键 `postId`；建议为 `tombId`、`trackId`、`authorUserId` 建索引。

**说明**：仅轨迹创建人可写；imageUrls 存 Cloud Storage 返回的 URL，多条用 JSON 数组存储。

---

### 3.7 Comment（评论）— V2.0 再创建

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| commentId | String | ✅ | ✅ | — | 评论唯一 ID |
| postId | String | — | ✅ | — | 所属图文 ID |
| authorUserId | String | — | ✅ | — | 评论人 userId |
| contentText | Text | — | ✅ | — | 评论内容 |
| createdAt | Date | — | — | — | 创建时间 |

**说明**：V1.0 不实现，上表供 V2.0 在 Cloud DB 中创建对象类型时参考。

---

### 3.8 FamilyMember（家庭空间成员）— V2.0 再创建

| 字段名 | 类型 | 主键 | 非空 | 默认值 | 说明 |
|--------|------|:----:|:----:|--------|------|
| id | String | ✅ | ✅ | — | 主键 |
| trackId | String | — | ✅ | — | 关联轨迹/家庭空间（或改为 familyId） |
| userId | String | — | ✅ | — | 成员 userId |
| role | String | — | ✅ | — | 角色：owner / admin / member |
| joinedAt | Date | — | — | — | 加入时间 |

**说明**：V1.0 不实现，上表供 V2.0 在 Cloud DB 中创建对象类型时参考。

---

## 四、实体关系简图（V1.0）

```
User (userId)
  │
  ├── 1:N → Track (ownerUserId)
  │           │
  │           ├── 1:N → TrackSegment (trackId)
  │           │           │
  │           │           ├── 1:N → TrackPoint (segmentId)
  │           │           └── 1:1 → TombSpot (segmentId)
  │           │
  │           └── 1:N → TombSpot (trackId) [也可通过 Segment 关联]
  │
  └── 1:N → Post (authorUserId)

TrackSegment (segmentId) ──1:1──→ TombSpot (segmentId)
TombSpot (tombId) ──1:N──→ Post (tombId)
```

---

## 五、在 AGC 控制台创建对象类型的步骤建议

1. 登录 [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html) → 您的项目 → **构建** → **云数据库**。
2. 在 **对象类型** 中依次新建：**User、Track、TrackSegment、TrackPoint、TombSpot、Post**（Comment、FamilyMember 留 V2.0）。
3. 每个对象类型下，按上表添加字段：选择 **字段类型**（String/Integer/Long/Double/Float/Boolean/Date/Text 等），勾选主键、非空、默认值（若支持）。
4. 为常用查询条件字段设置 **索引**（如 Track 的 ownerUserId、visibility、createdAt；TrackSegment 的 trackId；TrackPoint 的 segmentId；Post 的 tombId、trackId）。
5. 发布对象类型后，在客户端集成 Cloud DB SDK，并生成或手写与上述字段一致的本地模型类（如 ArkTS 的 interface/class），保证读写字段一致。

---

## 六、Cloud Storage 路径建议（与数据模型配合）

| 用途 | 建议路径示例 | 说明 |
|------|--------------|------|
| 用户头像 | `users/{userId}/avatar.{ext}` | 按用户隔离 |
| 轨迹封面 | `tracks/{trackId}/cover.{ext}` | 可选 |
| 墓地点图片 | `tracks/{trackId}/tombs/{tombId}/posts/{postId}/{index}.{ext}` | 与 Post.imageUrls 对应 |
| 分享海报 | `tracks/{trackId}/share.{ext}` | 生成后上传 |

---

以上内容可直接用于在 AGC 云数据库中创建对象类型及字段；若控制台字段类型名称与本文略有差异（如 Int vs Integer），以控制台为准。

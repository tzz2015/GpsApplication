# 扫墓轨迹 App 技术架构文档 V1.0（方案 A：鸿蒙 App + AGC BaaS）

## 一、总体技术选型
- **客户端平台**：HarmonyOS NEXT（鸿蒙原生 App，ArkTS）。
- **客户端技术栈**：
  - 语言与框架：ArkTS + 鸿蒙 UI（Stage 模型）。
  - 地图与定位：优先选择华为地图 SDK（HMS Core Map & Location），支持 2D/3D、海拔/高度展示。
  - 本地存储：鸿蒙首选 `Preference` / `RDB` / Local KV，用于轨迹本地缓存与离线数据。
- **后端能力（基于华为 AppGallery Connect，BaaS 方案）**：
  - 认证（AGC Auth）：手机号验证码登录 / 第三方账号登录（华为账号、微信等，按需要开通）。
  - 云数据库（AGC Cloud DB）：存储结构化业务数据（用户、轨迹、墓地点、家庭空间等）。
  - 云存储（AGC Cloud Storage）：存储图片、分享海报等大文件。
  - 云函数（AGC Cloud Functions）：承载少量核心业务逻辑（如分享统计、权限校验、定时任务等）。
- **通信方式**：
  - 客户端通过 AGC 提供的 SDK 直接访问 Cloud DB / Cloud Storage / Cloud Functions，无需自建 REST 服务。
  - 个别需要对外暴露的 H5/短链，可通过云函数或 AGC 托管页面实现。

## 二、系统整体架构
- **客户端层（鸿蒙 App）**
  - 负责 UI 展示、轨迹记录（GPS + 海拔）、权限控制的前端校验。
  - 通过 AGC SDK 直接读写 Cloud DB / Cloud Storage。
  - 提供离线记录功能：
    - 无网时先保存在本地（本地数据库/文件）；
    - 恢复网络后触发同步（调用 Cloud DB/Cloud Storage 上传）。
- **云后端层（AGC BaaS）**
  - **Auth**：统一身份认证和会话管理，为 App 提供用户身份信息和 Token。
  - **Cloud DB**：承载大部分业务数据模型和查询；支持本地缓存与云端同步机制。
  - **Cloud Storage**：存放轨迹截图、墓地照片、分享海报等。
  - **Cloud Functions**：用于复杂逻辑和安全敏感操作（如分享统计、轨迹公开/家庭可见逻辑的服务端校验等）。
- **第三方服务**
  - HMS Core 地图与定位。
  - 短信服务（通过 AGC 或合作短信服务商）。

## 三、核心模块技术设计（基于方案 A）
### 3.1 定位与轨迹记录模块（客户端侧为主）
- 使用 HMS Core 定位服务，周期性获取：
  - 经纬度（longitude, latitude）、海拔（altitude）、时间戳、精度。
- 轨迹记录策略：
  - 在本地以点序列方式缓存（例如：每 n 米或每 n 秒采样一次）。
  - 分段（Segment）以“起点/终点事件”为界：用户点击“开始段 / 结束段”时生成一段。
- 同步到云端：
  - 结束一段后将该段的轨迹点批量写入 Cloud DB。
  - 根据需要可对轨迹点进行压缩或抽稀（可在 Cloud Functions 中处理）。

### 3.2 轨迹、墓地点与图文内容模块（Cloud DB 设计）
- 以 Cloud DB 的实体（Entity）建模：
  - `UserEntity`：用户基本信息。
  - `TrackEntity`：一条完整扫墓轨迹（名称、描述、创建人、可见范围等；V1.0 仅支持 `PUBLIC` / `PRIVATE`，`FAMILY` 将在 V2.0 引入）。
  - `TrackSegmentEntity`：轨迹段（起点/终点名称、顺序索引等）。
  - `TrackPointEntity`：轨迹点（关联 Segment、经纬度、海拔、时间戳等）。
  - `TombSpotEntity`：墓地点信息（可与轨迹段终点一一对应）。
  - `PostEntity`：图文内容（关联墓地点/轨迹，作者、文字、图片列表等，仅轨迹创建人可写）。
  - `CommentEntity`：评论（V2.0 以后再启用，V1.0 不实现）。
  - `FamilyMemberEntity`：家庭空间成员/角色信息（V2.0 以后再启用）。
- 图片处理流程：
  - 客户端选择/拍摄照片 → 压缩 → 上传至 Cloud Storage → 获得文件 URL。
  - 在 Cloud DB 的 `PostEntity` 中保存该 URL 与相关元数据。

### 3.3 家庭空间与权限控制（Auth + Cloud DB + Cloud Functions）
- 权限模型：
  - 在 `TrackEntity` 中维护可见范围字段：`PUBLIC` / `FAMILY` / `PRIVATE`。
  - 在 `FamilyMemberEntity` 中维护家庭成员关系和角色（创建人/管理员/普通成员）。
- 权限校验策略：
  - 简单读写权限可在客户端根据当前用户信息 + Cloud DB 字段做一次前置判断。
  - 对于敏感操作（删除内容、修改可见范围、管理成员等），调用 Cloud Functions 在服务端再次校验：
    - 当前用户是否为轨迹创建人或管理员；
    - 是否属于对应家庭空间成员。

### 3.4 巡航与导航模块（地图 SDK + 本地数据）
- 客户端从 Cloud DB 拉取某条轨迹/某段轨迹的点集合，在本地构造 polyline，交给地图 SDK 渲染。
- 实现：
  - 2D/3D 切换使用地图 SDK 提供的接口；
  - 使用当前定位点与轨迹点集合计算：最近轨迹点、与下一墓地点的直线距离，绘制方向箭头或文字提示。
- 适配弱网场景：
  - 轨迹点数据在上一次查看时可缓存到本地，下次在山上可离线展示 polyline。

## 四、数据模型（Cloud DB 实体简要示例）
- `UserEntity`：userId、phone、nickname、avatarUrl、createdAt 等。
- `TrackEntity`：trackId、ownerUserId、title、description、visibility、status（editing/done）、createdAt 等。
- `TrackSegmentEntity`：segmentId、trackId、orderIndex、startName、endName、startPointRef、endPointRef 等。
- `TrackPointEntity`：pointId、segmentId、orderIndex、lat、lng、altitude、timestamp 等。
- `TombSpotEntity`：tombId、segmentId（或 trackId）、name、personInfo、remark、lat、lng、altitude 等。
- `PostEntity`：postId、tombId、authorUserId、contentText、imageUrls、isPinned、createdAt 等。
- `CommentEntity`：commentId、postId、authorUserId、contentText、createdAt 等。
- `FamilyMemberEntity`：id、trackId（或 familyId）、userId、role、joinedAt 等。

> 具体字段类型、索引策略可在 Cloud DB 设计阶段进一步细化。

## 五、非功能技术方案（结合 AGC）
- **安全**：
  - 统一通过 AGC Auth 管理用户身份和 Token，客户端所有敏感读写均需携带有效 Token。
  - Cloud Functions 中对关键操作进行权限再校验，防止仅靠前端逻辑。
- **性能与稳定性**：
  - 充分利用 Cloud DB 的本地缓存能力，减少频繁网络请求。
  - 合理设计实体与索引，控制轨迹点数据量（可对较旧轨迹做抽稀或归档）。
- **扩展性**：
  - 业务逻辑尽量通过 Cloud Functions 封装，后续若迁移到自建后端可较容易迁移（接口边界清晰）。

## 六、发布与运维（基于 AGC）
- **环境管理**：
  - 使用 AGC 的多项目/多环境能力区分开发、测试、生产环境。
- **监控与日志**：
  - 使用 AGC 提供的统计与诊断功能（Crash、性能、调用量等）监控 App 状态。
  - Cloud Functions 侧查看函数调用日志与错误记录。
- **备份与容灾**：
  - Cloud DB 与 Cloud Storage 由 AGC 托管，默认具备多副本与基础容灾能力；重要数据可考虑周期性导出备份。




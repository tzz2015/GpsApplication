# 遨游轨迹 App 技术架构文档 V1.0（方案 A：鸿蒙 App + AGC BaaS）

## 一、总体技术选型
- **客户端平台**：HarmonyOS NEXT（鸿蒙原生 App，ArkTS）。
- **客户端技术栈**：
  - 语言与框架：ArkTS + 鸿蒙 UI（Stage 模型）。
  - 地图与定位：优先选择华为地图 SDK（HMS Core Map & Location），支持 2D/3D、海拔/高度展示。
  - 本地存储：鸿蒙首选 `Preference` / `RDB` / Local KV，用于轨迹本地缓存与离线数据。
- **后端能力（基于华为 AppGallery Connect，BaaS 方案）**：
  - 认证（AGC Auth）：V1.0 仅支持鸿蒙授权登录（AGC 与华为账号体系打通）；手机验证码登录及其他第三方登录不做。
  - 云数据库（AGC Cloud DB）：存储结构化业务数据（用户、轨迹、墓地点、家庭空间等）。
  - 云存储（AGC Cloud Storage）：存储图片、分享海报等大文件。
  - 云函数（AGC Cloud Functions）：承载少量核心业务逻辑（如分享统计、权限校验、定时任务等）。
- **通信方式**：
  - 客户端通过 AGC 提供的 SDK 直接访问 Cloud DB / Cloud Storage / Cloud Functions，无需自建 REST 服务。
  - 个别需要对外暴露的 H5/短链，可通过云函数或 AGC 托管页面实现。

## 二、系统整体架构
- **客户端层（鸿蒙 App）**
  - **首页双 Tab 结构**：Tab1「首页（公开轨迹）」展示所有可见范围为公开的轨迹列表（Cloud DB 查询 `visibility = PUBLIC`，按创建时间倒序）；Tab2「我的轨迹」展示当前用户创建的轨迹列表。两 Tab 共用轨迹详情页，根据是否为创建人决定是否展示编辑/删除等能力。
  - 负责 UI 展示、轨迹记录（GPS + 海拔）、权限控制的前端校验。
  - 通过 AGC SDK 直接读写 Cloud DB / Cloud Storage。
  - 提供离线记录功能：
    - 无网时先保存在本地（本地数据库/文件）；
    - 恢复网络后触发同步（调用 Cloud DB/Cloud Storage 上传）。
- **云后端层（AGC BaaS）**
  - **Auth**：统一身份认证和会话管理（V1.0 仅支持鸿蒙授权登录），为 App 提供用户身份信息和 Token。
  - **Cloud DB**：承载大部分业务数据模型和查询；支持本地缓存与云端同步机制。
  - **Cloud Storage**：存放轨迹截图、墓地照片、分享海报等。
  - **Cloud Functions**：用于复杂逻辑和安全敏感操作（如分享统计、轨迹公开/家庭可见逻辑的服务端校验等）。
- **第三方服务**
  - HMS Core 地图与定位。
  - 短信服务（通过 AGC 或合作短信服务商）。

## 三、核心模块技术设计（基于方案 A）

### 模块划分（定位 → location，地图 → map）

- **location 模块**：负责所有**定位相关**逻辑——定位权限、持续/单次定位、轨迹点采样（经纬度、海拔、时间戳）、轨迹点序列缓存；对外提供接口或组件供 entry 的轨迹记录页调用。
- **map 模块**：负责所有**地图相关**逻辑——地图初始化、2D/3D、轨迹线（polyline）绘制、墓地点标记、当前位置、地图截图等；对外提供地图组件供 entry 的轨迹记录页、轨迹详情页嵌入。
- **entry 模块**：主入口与页面（登录、首页、轨迹记录/详情等），只做 UI 与路由，通过依赖 location、map 使用其能力，不在 entry 内实现定位/地图具体实现。

### 3.1 定位与轨迹记录模块（客户端侧为主，实现于 location 模块）
- 使用 HMS Core 定位服务，周期性获取：
  - 经纬度（longitude, latitude）、海拔（altitude）、时间戳、精度。
- 轨迹记录策略：
  - 在本地以点序列方式缓存（例如：每 n 米或每 n 秒采样一次）。
  - **一条轨迹**为一条连续路径：用户**设置起点**后开始记录，途中可**暂停/继续**；到达墓地时**设置打卡点**（即墓地点），可添加图文；最后**设置终点**结束轨迹。
  - 轨迹点（TrackPoint）直接归属一条轨迹（trackId），按时间序排列；打卡点（TombSpot）按顺序关联该轨迹。
- **轨迹点数据量与优化（必做）**：
  - **问题**：长时间记录（如数小时扫墓）会产生大量轨迹点，直接全量写入 Cloud DB 会导致存储与查询成本高、弱网上传慢、列表/详情加载慢。
  - **推荐策略**（组合使用）：
    1. **采集端采样（location 模块）**：记录时即控制点数——按**距离阈值**（如每移动 3～5 米采一点）或**时间+距离**（如至少间隔 5 秒且移动超过 2 米）写入一个轨迹点，避免 1 秒一个点的高频冗余。
    2. **上传前抽稀（客户端或 Cloud Functions）**：在设置打卡点或结束轨迹、上传前，对当前轨迹点序列做**抽稀**，在保证路径形状可接受的前提下减少点数。常用算法：**Douglas-Peucker（道格拉斯-普克）**：给定距离容差 ε，保留能近似代表整条折线的关键点，直线段中间点可删；或**垂距/角度阈值**简化。抽稀后重排 `orderIndex` 再写入 Cloud DB。
    3. **云端可选二次抽稀（Cloud Functions）**：对已上传的轨迹，可按策略（如仅保留每 N 个点、或按 Douglas-Peucker 再算一遍）生成「展示用简化序列」，存为单独字段或单独对象类型（V2.0 可做）；V1.0 若客户端抽稀已足够，可暂不实现。
  - **存储约定**：写入 Cloud DB 的轨迹点应为**已采样且经抽稀后的点集**，保证一条轨迹点数在合理范围（如单条轨迹建议控制在数百点到约一两千点以内，视业务可接受形状精度调整）。
- 同步到云端：
  - 设置打卡点或结束轨迹时，将**经采样与抽稀后的**轨迹点及打卡点数据写入 Cloud DB。
  - 抽稀可在客户端上传前完成，或由 Cloud Functions 在上传后异步执行（V1.0 建议客户端上传前抽稀，逻辑简单、减少云端计算）。

### 3.2 轨迹、打卡点（墓地点）与图文内容模块（Cloud DB 设计）
- 以 Cloud DB 的实体（Entity）建模：
  - `UserEntity`：用户基本信息。
  - `TrackEntity`：一条完整扫墓轨迹（名称、描述、创建人、可见范围等；V1.0 仅支持 `PUBLIC` / `PRIVATE`，`FAMILY` 将在 V2.0 引入）。一条轨迹仅一条连续路径，含起点、若干打卡点、终点。
  - `TrackPointEntity`：轨迹点（关联 Track、经纬度、海拔、时间戳、顺序索引等）。
  - `TombSpotEntity`：打卡点（墓地点）信息（关联 Track、顺序索引、名称、经纬度、海拔等；对应轨迹上的每个墓地）。
  - `PostEntity`：图文内容（关联墓地点/轨迹，作者、文字、图片列表等，仅轨迹创建人可写）。
  - `CommentEntity`：评论（V2.0 以后再启用，V1.0 不实现）。
  - `FamilyMemberEntity`：家庭空间成员/角色信息（V2.0 以后再启用）。
  - 说明：V1.0 不再使用“轨迹段（Segment）”概念，轨迹点直接关联 Track，打卡点按顺序关联 Track。
- 图片处理流程：
  - 客户端选择/拍摄照片 → 压缩 → 上传至 Cloud Storage → 获得文件 URL。
  - 在 Cloud DB 的 `PostEntity` 中保存该 URL 与相关元数据。

### 3.3 家庭空间与权限控制（Auth + Cloud DB + Cloud Functions）
- 权限模型：
  - 在 `TrackEntity` 中维护可见范围字段：`PUBLIC` / `FAMILY` / `PRIVATE`。
  - 在 `FamilyMemberEntity` 中维护家庭成员关系和角色（创建人/管理员/普通成员）。
- 权限校验策略：
  - 简单读写权限可在客户端根据当前用户信息 + Cloud DB 字段做一次前置判断。
  - 对于敏感操作（删除内容、修改可见范围、管理成员等），调用 Cloud Functions 在服务端再次校验：
    - 当前用户是否为轨迹创建人或管理员；
    - 是否属于对应家庭空间成员。

### 3.4 巡航与导航模块（地图 SDK + 本地数据，实现于 map 模块）
- 客户端从 Cloud DB 拉取某条轨迹/某段轨迹的点集合，在本地构造 polyline，交给地图 SDK 渲染（**地图展示与绘制逻辑放在 map 模块**）。
- 实现：
  - 2D/3D 切换使用地图 SDK 提供的接口；
  - 使用当前定位点与轨迹点集合计算：最近轨迹点、与下一墓地点的直线距离，绘制方向箭头或文字提示。
- 适配弱网场景：
  - 轨迹点数据在上一次查看时可缓存到本地，下次在山上可离线展示 polyline。

### 3.5 认证与登录（鸿蒙授权 + AGC Auth）
- **登录方式**：V1.0 仅支持鸿蒙授权登录一种方式；通过 AGC Auth 统一签发 Token，Cloud DB/Cloud Storage/Cloud Functions 校验该 Token。手机验证码登录及其他第三方登录不做。
- **鸿蒙账号与 AGC 打通**：
  - 在 AGC 控制台开通「华为账号」登录方式，并配置与当前 App 的关联（包名、签名等）。
  - 客户端使用 AGC Auth SDK 提供的华为账号登录接口（如 `AGConnectAuth.getAuth().signIn(credential)`，credential 为华为账号凭证），由 AGC 完成与华为账号服务的校验并返回 AGC 用户标识与 Token。
  - 首次通过鸿蒙账号登录时，AGC 会创建对应用户；后续用同一鸿蒙账号登录即复用该 AGC 用户，保证 Cloud DB 中 `UserEntity` 与轨迹数据的归属一致。
- **客户端实现要点**：登录前检查本地是否已有有效 Token；登录成功后持久化 Token（或由 SDK 管理），请求 Cloud DB/Cloud Storage 时自动携带；登出时清除本地会话并可选调用 AGC 登出接口。

## 四、数据模型（Cloud DB 实体简要示例）
- `UserEntity`：userId、phone、nickname、avatarUrl、createdAt 等。
- `TrackEntity`：trackId、ownerUserId、title、description、visibility、status（editing/done）、startName、endName、createdAt 等。
- `TrackPointEntity`：pointId、trackId、orderIndex、lat、lng、altitude、timestamp 等（一条轨迹一条连续点序列，支持暂停/继续产生的间隙）。
- `TombSpotEntity`：tombId、trackId、orderIndex、name、personInfo、remark、lat、lng、altitude 等（打卡点即墓地点，按顺序关联轨迹）。
- `PostEntity`：postId、tombId、authorUserId、contentText、imageUrls、isPinned、createdAt 等。
- `CommentEntity`：commentId、postId、authorUserId、contentText、createdAt 等。
- `FamilyMemberEntity`：id、trackId（或 familyId）、userId、role、joinedAt 等。

> 具体字段类型、索引策略可在 Cloud DB 设计阶段进一步细化。

## 五、非功能技术方案（结合 AGC）
- **安全**：
  - 统一通过 AGC Auth 管理用户身份和 Token，客户端所有敏感读写均需携带有效 Token。
  - Cloud Functions 中对关键操作进行权限再校验，防止仅靠前端逻辑。
- **性能与稳定性**：
  - 充分利用 Cloud DB 的本地缓存能力，减少频繁网络请求。
  - **轨迹点数据量控制（必做）**：采集端按距离/时间采样 + 上传前抽稀（如 Douglas-Peucker），使写入 Cloud DB 的轨迹点数量在合理范围内；对较旧轨迹可做二次抽稀或归档（见 3.1 节）。
  - 合理设计实体与索引，配合轨迹点优化减轻单条轨迹的读写与存储压力。
- **扩展性**：
  - 业务逻辑尽量通过 Cloud Functions 封装，后续若迁移到自建后端可较容易迁移（接口边界清晰）。

## 六、发布与运维（基于 AGC）
- **环境管理**：
  - 使用 AGC 的多项目/多环境能力区分开发、测试、生产环境。
- **监控与日志**：
  - 使用 AGC 提供的统计与诊断功能（Crash、性能、调用量等）监控 App 状态。
  - Cloud Functions 侧查看函数调用日志与错误记录。
- **备份与容灾**：
  - Cloud DB 与 Cloud Storage 由 AGC 托管，默认具备多副本与基础容灾能力；重要数据可考虑周期性导出备份。




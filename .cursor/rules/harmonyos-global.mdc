---
alwaysApply: true
---
# 鸿蒙开发全局规则

## 一、官方文档与参考（写代码时优先查阅）

- **鸿蒙应用开发指南（必读）**：https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-dev-guide  
  编写或修改鸿蒙相关代码时，应优先查阅该文档，按官方指南与 API 规范实现，避免使用已废弃或非推荐写法。

- **编译与构建 FAQ（必遵）**：https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-compiling-and-building-30  
  后续开发与修复编译/构建告警时，须按该规范执行：包括但不限于弃用 API 的替代方式、编译选项、构建配置、Code Linter 与修复建议等。出现 ArkTS 弃用告警（如 getContext、pushUrl/replaceUrl、packing、showToast 等）时，应查阅官方文档采用推荐 API 或迁移方案，并确保构建通过、告警消除或收敛。

- **路由与弹窗（避免全局 router/AlertDialog 弃用）**：页面跳转、返回、取参必须通过 **UIContext** 获取的实例调用，禁止直接使用全局 `router` 或 `AlertDialog`。应使用 `this.getUIContext().getRouter().pushUrl()` / `replaceUrl()` / `back()` / `getParams()` 替代 `router.push` / `router.replace` / `router.back` / `router.getParams()`；使用 `this.getUIContext().getPromptAction().showDialog({ message, buttons })` 替代 `AlertDialog.show()`。在非组件内需先持有 UIContext 再调用。

## 二、轨迹 App 项目与技术栈

- **项目**：遨游轨迹 HarmonyOS App（AiApplication），见 `doc/需求设计/需求文档v1.0.md`、`doc/需求设计/页面流程与原型说明v1.0.md`、`doc/技术文档/技术架构文档v1.0.md`。轨迹为单条路径（起点、打卡点、终点），支持暂停/继续；不拆分多段。
- **客户端**：HarmonyOS NEXT 原生，ArkTS + ArkUI，Stage 模型。
- **后端**：AGC BaaS（Auth 鸿蒙授权、Cloud DB、Cloud Storage、Cloud Functions），V1.0 不做手机验证码及第三方登录。
- **页面与路由**：页面放在各模块 `src/main/ets/pages/`，路由在 `main_pages.json` 中配置；新增页面需同步更新 `main_pages.json`。
- **模块**：`entry` 为主入口；`location`、`map` 等为功能模块，按职责拆分，避免在 entry 中堆砌所有逻辑。
- **设计与实现参考**：做功能或页面时，优先查阅 `doc/` 下需求文档、页面流程与原型说明、技术架构文档；首页为双 Tab（我的轨迹 | 所有轨迹），底部仅两 Tab：首页、个人中心；空状态与创建入口按《页面流程与原型说明》处理。
- **原型设计（UI 必读）**：`doc/需求设计/prototype/prototype.html` 是完整的交互原型，包含所有页面的布局、颜色、间距、交互细节。**编写或修改任何页面 UI 时，必须先读取该原型文件，按其中的视觉规范（配色、字号、间距、圆角、卡片风格等）实现界面**，确保实际效果与原型一致。

---

## 三、项目结构与命名规范

- 所有文件和目录使用小写字母和连字符命名（如 `user-profile.ets`）。
- 组件文件使用 `.ets` 后缀。
- 页面文件使用 `page.ets` 后缀（或与路由一致的命名）。
- 资源文件使用 `resources` 目录统一管理。

## 四、代码风格与类型安全（arkts-no-any-unknown 零容忍）

- 使用 ArkTS/TypeScript 进行类型标注。
- **⚠️ ArkTS 绝对禁止 `any` 与 `unknown`（编译器规则 arkts-no-any-unknown，违反即编译失败）**：
  所有变量、参数、返回值、泛型都必须使用明确的具体类型，包括隐式产生 `any` 的场景：
  1. `JSON.parse()` 返回值 → 必须 `as SomeType` 断言：`JSON.parse(str) as string[]`
  2. `catch (e)` 异常 → 必须 `const err = e as BusinessError;`
  3. Promise/回调参数 → 必须标注：`.then((ok: boolean) => { ... })`
  4. SDK 返回值 → 必须标注：`const user: AuthUser | null = await auth.getCurrentUser();`
  5. 函数参数和返回值 → 必须显式声明类型
  6. 空数组 → 必须泛型：`const arr: string[] = [];`
  7. 对象字面量传给 SDK 方法 → 确保匹配接口类型或用断言
- 使用 `interface` 定义对象类型。
- **⚠️ ArkTS 禁止用对象字面量作类型声明（arkts-no-obj-literals-as-types，违反即编译失败）**：
  不得在类型断言、类型标注、泛型参数等处使用内联对象字面量类型，例如禁止 `event as { scale?: number }`、`event as { offsetX?: number; offsetY?: number }`、`(x: { a: number }) => {}`。必须为每种形状单独定义 `interface` 或 `type` 再使用，例如定义 `interface PinchEventLike { scale?: number; }` 后使用 `event as PinchEventLike`。
- 启用严格模式检查。
- 使用明确的类型注解和泛型提高代码复用性。
- 界面与业务逻辑使用 **ArkTS**（`.ets`），勿用纯 TypeScript/JavaScript 写 UI。
- **ArkTS 不支持对象展开运算符**：禁止使用 `...` 展开对象或数组（如 `{ ...obj }`、`{ ...a, ...b }`、`[...arr]`）。对象合并应改为逐字段赋值或使用 `Object.assign`；数组合并使用 `concat`、`slice` 或逐项赋值。新建对象时显式列出每个属性，避免 `...existing` 的写法。
- **ArkTS 不支持 TypeScript Utility Type**：禁止使用 `Partial<T>`、`Required<T>`、`Pick<T, K>`、`Omit<T, K>`、`Record<K, V>` 等工具类型。需用显式 `interface` 定义替代，例如“部分字段可选”时单独定义一份所有属性均为可选的接口（如 `TrackUpdate`）供更新入参使用。

## 五、组件与页面开发规范

- 使用 ArkUI 声明式语法（`@Component`、`build()`、状态 `@State`、`@Prop` 等），遵循 Stage 模型与方舟开发范式。
- 组件应保持单一职责，避免混合过多逻辑。
- 页面组件应遵循鸿蒙官方组件封装规范。
- 使用 `@Component` 装饰器定义组件。
- 组件状态管理应使用 `@State`、`@Prop`、`@Link` 等装饰器。

## 六、API 调用与错误处理

- 所有异步操作必须包含错误处理逻辑。
- 使用 `try-catch` 包裹可能出错的异步调用。
- 对于网络请求（含 AGC Cloud DB/Storage/Functions），应包含超时和重试机制。
- 错误信息应清晰明确，便于调试。

## 七、性能优化

- 避免在渲染函数（如 `build()`）中执行耗时操作。
- 合理使用 `@Builder` 装饰器优化构建过程。
- 对于复杂列表，使用 `lazyLoad` 优化性能。
- 避免不必要的状态更新。

## 八、安全性

- 不在代码中硬编码敏感信息（如 API 密钥、Token）。
- 所有用户输入必须进行验证和清理。
- 使用鸿蒙提供的安全 API 进行数据加密和存储。

## 九、测试与调试

- 每个组件应有对应的单元测试。
- 使用 `@Test` 装饰器标记测试函数。
- 在开发阶段启用调试日志，生产环境关闭。
- 使用鸿蒙提供的调试工具进行性能分析。

## 十、代码质量要求

- 代码必须能够立即运行，包含所有必要的导入和依赖。
- 遵循鸿蒙官方最佳实践和设计模式。
- 优先考虑性能和用户体验。
- 确保代码的可读性和可维护性。

## 十一、状态管理规范

- 使用 `@State` 管理组件内部状态。
- 使用 `@Prop` 接收父组件传递的属性。
- 使用 `@Provide` 和 `@Consume` 实现跨层级状态传递。
- 避免在组件间直接传递复杂对象。

## 十二、生命周期管理

- 正确使用组件生命周期方法。
- 在组件销毁时清理资源和定时器。
- 合理使用 `onAppear` 和 `onDisappear` 进行页面级操作。

## 十三、资源管理

- 图片资源统一放在 `resources` 目录下。
- 使用资源管理器管理动态资源。
- 避免硬编码资源路径。
- 合理使用资源的尺寸和格式。

## 十四、网络请求规范

- 统一使用鸿蒙提供的网络请求 API（本项目通过 AGC SDK 访问 Cloud DB/Storage/Functions，需含超时与重试）。
- 添加请求拦截器处理通用逻辑（如 Token 携带）。
- 实现请求缓存机制。
- 处理网络异常和超时情况。

## 十五、数据存储规范

- 使用 `Preferences` 进行轻量级数据存储（如登录态、本地配置）。
- 使用数据库（RDB/Local KV）进行复杂数据管理（如轨迹本地缓存、离线数据）。
- 实现数据持久化和同步机制（无网先存本地，有网再同步 AGC）。
- 注意数据安全和隐私保护。

## 十六、UI 交互规范

- 遵循鸿蒙 UI 设计规范。
- 合理使用动画和过渡效果。
- 实现响应式布局。
- 适配不同屏幕尺寸。
- **⚠️ 滑动回弹（必须）**：所有可滚动容器（`Scroll`、`List`、`WaterFlow` 等）必须添加 `.edgeEffect(EdgeEffect.Spring)`，确保上拉/下拉到边界时有弹簧回弹效果。这是华为云测体验规范的硬性要求，缺失回弹会导致测试不通过。新建页面时，若页面内容可能超出一屏或含列表，默认使用 `Scroll` 包裹并加 `.edgeEffect(EdgeEffect.Spring)`。注意：`EdgeEffect` 是 ArkUI 全局内置枚举，**不需要 import**，直接使用即可。

## 十七、调试与日志

- 使用鸿蒙提供的调试工具。
- 实现结构化的日志记录。
- 区分不同级别的日志信息。
- 在生产环境中关闭调试日志。

## 十八、构建与部署

- **遵循华为编译与构建 FAQ**：https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-compiling-and-building-30 （与第一节「编译与构建 FAQ（必遵）」一致）。
- 正确配置 `build-profile.json5` 和 `hvigorfile.ts`。
- 正确配置应用签名信息。
- 在 `module.json5` 中正确声明权限（定位、网络、存储等）。
- 合理设置 API 版本和兼容版本。

## 十九、开发环境与工具

- 使用 DevEco Studio 开发。
- 优先使用 ArkTS 语言。
- 主推 Stage 模型。
- 集成 AI 工具提升开发效率。

## 二十、模块化与架构

- 采用视图、模型、逻辑分离。
- 实现模块化组件设计。
- 合理设计状态管理机制。
- 统一管理工具类和公共方法。

## 二十一、分布式能力（可选）

- 利用分布式架构特性（若后续扩展多设备）。
- 通过 ArkUI 和 Ability 实现跨平台开发。
- 适配资源受限设备。

## 二十二、性能监控

- 实现应用性能监控。
- 监控内存使用情况。
- 监控页面渲染性能。
- 实现异常监控和上报（可结合 AGC 诊断）。

## 二十三、用户体验

- 优化首屏加载速度。
- 提供良好的加载状态提示。
- 实现流畅的动画效果。
- 保证应用稳定性。

## 二十四、兼容性处理

- 处理不同设备型号的兼容性。
- 适配不同系统版本。
- 处理不同屏幕密度。
- 实现降级处理机制。

## 二十五、国际化支持（可选）

- 支持多语言资源管理。
- 实现动态语言切换。
- 处理不同地区的日期时间格式。
- 支持不同地区的数字格式。

## 二十六、代码复用

- 提取公共组件和工具方法。
- 实现可复用的业务逻辑。
- 建立组件库和工具库。
- 避免重复代码实现。

## 二十七、文档规范

- 为重要组件添加注释说明。
- 实现 API 文档自动生成（若适用）。
- 维护项目开发文档（与 `doc/` 保持一致）。
- 提供使用示例和最佳实践。

## 二十八、编译验证（强制）

- **每次修改代码后，必须自动执行编译命令验证**：在项目根目录运行 `hvigorw assembleHap --mode module -p product=default --no-daemon`。
- 编译如有 ERROR（非第三方库 WARN），必须立即修复并重新编译，循环直到 `BUILD SUCCESSFUL`。
- 仅第三方库的 WARN（如 `@hw-agconnect/auth` 的 `arkts-strict-typing-required`）和已知弃用提示（如 `PhotoViewPicker`）可忽略。
- 不得跳过编译步骤、不得在编译未通过时声称修改完成。

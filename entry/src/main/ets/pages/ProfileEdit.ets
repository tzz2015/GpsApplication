import { common } from '@kit.AbilityKit';
import { picker } from '@kit.CoreFileKit';
import { NavBar } from '../common/NavBar';
import { AuthStore } from '../common/AuthStore';
import { SyncService } from '../common/SyncService';
import { CloudStorageService } from '../common/CloudStorageService';

/**
 * P3-2 ä¸ªäººä¿¡æ¯ç¼–è¾‘é¡µï¼šå¤´åƒã€æ˜µç§°ã€å®¶æ—ã€ç­¾å
 */
@Entry
@Component
struct ProfileEdit {
  @State nickname: string = '';
  @State familyName: string = '';
  @State avatarUrl: string = '';
  @State isSaving: boolean = false;
  @State isUploadingAvatar: boolean = false;

  aboutToAppear(): void {
    this.loadUserInfo();
  }

  private async loadUserInfo(): Promise<void> {
    const context = this.getUIContext().getHostContext() as common.Context;
    const user = await AuthStore.getCurrentUser(context);
    if (user) {
      this.nickname = user.displayName;
      this.familyName = user.familyName;
      this.avatarUrl = user.avatarUrl;
    }
  }

  private async saveUserInfo(): Promise<void> {
    this.isSaving = true;
    const context = this.getUIContext().getHostContext() as common.Context;
    await AuthStore.updateUser(context, {
      displayName: this.nickname,
      familyName: this.familyName,
      avatarUrl: this.avatarUrl
    });
    // åŒæ­¥åˆ° Cloud DBï¼Œé‡è£…åç™»å½•å¯æ¢å¤æ˜µç§°
    SyncService.syncUser(context).catch(() => {});
    this.isSaving = false;
    this.getUIContext().getRouter().back();
  }

  /** é€‰æ‹©ç…§ç‰‡å¹¶ä¸Šä¼ ä¸ºå¤´åƒ */
  private async pickAndUploadAvatar(): Promise<void> {
    if (this.isUploadingAvatar) {
      return;
    }
    const context = this.getUIContext().getHostContext() as common.Context;
    const user = await AuthStore.getCurrentUser(context);
    if (!user) {
      return;
    }
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });
      if (result && result.photoUris && result.photoUris.length > 0) {
        const uri: string = result.photoUris[0];
        this.isUploadingAvatar = true;
        const cloudUrl: string = await CloudStorageService.uploadUserAvatar(context, user.userId, uri);
        this.isUploadingAvatar = false;
        if (cloudUrl.length > 0) {
          this.avatarUrl = cloudUrl;
          await AuthStore.updateUser(context, { avatarUrl: cloudUrl });
          SyncService.syncUser(context).catch(() => {});
        }
      }
    } catch (e) {
      this.isUploadingAvatar = false;
    }
  }

  build() {
    Column() {
      NavBar({ title: 'ç¼–è¾‘ä¸ªäººä¿¡æ¯', showBack: true });

      Scroll() {
        Column() {
          // å¤´åƒåŒºåŸŸï¼ˆå¯ç‚¹å‡»æ›´æ¢ï¼‰ï¼Œé¡¶éƒ¨æ— ç•™ç™½
          Column({ space: 12 }) {
            Stack() {
              if (this.avatarUrl.length > 0) {
                Image(this.avatarUrl)
                  .width(80)
                  .height(80)
                  .borderRadius(40)
                  .objectFit(ImageFit.Cover);
              } else {
                Column() {
                  Text('ğŸ‘¤')
                    .fontSize(36);
                }
                .width(80)
                .height(80)
                .borderRadius(40)
                .backgroundColor($r('app.color.primary_light'))
                .justifyContent(FlexAlign.Center);
              }
              // ç›¸æœºè§’æ ‡
              Column() {
                Text(this.isUploadingAvatar ? 'â€¦' : 'ğŸ“·')
                  .fontSize(14);
              }
              .width(28)
              .height(28)
              .borderRadius(14)
              .backgroundColor('#3478F6')
              .justifyContent(FlexAlign.Center)
              .borderWidth(2)
              .borderColor(Color.White)
              .position({ x: 56, y: 56 });
            }
            .width(80)
            .height(80)
            .onClick(() => {
              this.pickAndUploadAvatar();
            });
            Text(this.isUploadingAvatar ? 'ä¸Šä¼ ä¸­â€¦' : 'ç‚¹å‡»æ›´æ¢å¤´åƒ')
              .fontSize(13)
              .fontColor($r('app.color.label_tertiary'));
          }
          .width('100%')
          .padding(24)
          .backgroundColor($r('app.color.card_background'))
          .alignItems(HorizontalAlign.Center);

          Column().width('100%').height(8).backgroundColor($r('app.color.app_background'));

          // è¡¨å•
          Column({ space: 16 }) {
            Column({ space: 6 }) {
              Text('æ˜µç§°')
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.label_secondary'));
              TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°', text: this.nickname })
                .onChange((value: string) => {
                  this.nickname = value;
                })
                .width('100%')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.app_background'))
                .borderRadius(10)
                .padding({ left: 12, right: 12 });
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start);

            Column({ space: 6 }) {
              Text('æ‰€å±å®¶æ—')
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.label_secondary'));
              TextInput({ placeholder: 'ä¾‹å¦‚ï¼šåˆ˜æ°', text: this.familyName })
                .onChange((value: string) => {
                  this.familyName = value;
                })
                .width('100%')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.app_background'))
                .borderRadius(10)
                .padding({ left: 12, right: 12 });
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start);
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.card_background'));
        }
        .width('100%');
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor($r('app.color.app_background'));

      Button(this.isSaving ? 'ä¿å­˜ä¸­â€¦' : 'ä¿å­˜')
        .width('90%')
        .height(50)
        .fontSize(17)
        .fontWeight(FontWeight.Medium)
        .fontColor(Color.White)
        .backgroundColor($r('app.color.primary'))
        .borderRadius(25)
        .enabled(!this.isSaving)
        .margin({ bottom: 32 })
        .onClick(() => {
          this.saveUserInfo();
        });
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }
}

import { promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { TrackStore } from '../common/TrackStore';
import { TrackModel } from '../common/TrackModel';
import { AuthStore, AuthUser } from '../common/AuthStore';
import { SyncService } from '../common/SyncService';
import { CloudDBService } from '../common/CloudDBService';

const LOG_DOMAIN = 0x0000;
const LOG_TAG = 'Main';
/** æˆ‘çš„è½¨è¿¹åˆ—è¡¨æ¯é¡µæ¡æ•°ï¼Œæ”¯æŒåˆ†é¡µåŠ è½½æ›´å¤š */
const MY_TRACKS_PAGE_SIZE = 20;

/**
 * P1-0 é¦–é¡µï¼ˆé¡¶éƒ¨ Tabï¼šæˆ‘çš„è½¨è¿¹ | å…¬å¼€è½¨è¿¹ï¼‰+ P3-1 ä¸ªäººä¸­å¿ƒ
 */
@Entry
@Component
struct Main {
  @StorageProp('statusBarHeight') statusBarHeight: number = 0;
  @StorageProp('bottomSafeHeight') bottomSafeHeight: number = 0;
  @State currentBottomIndex: number = 0;
  @State currentTopIndex: number = 0;
  @State myTracks: TrackModel.Track[] = [];
  @State myTracksDisplayCount: number = MY_TRACKS_PAGE_SIZE;
  @State publicTracks: TrackModel.Track[] = [];
  @State publicTracksDisplayCount: number = MY_TRACKS_PAGE_SIZE;
  @State isLoading: boolean = false;
  @State currentUser: AuthUser | null = null;
  @State diagResult: string = '';
  @State isDiagnosing: boolean = false;

  aboutToAppear(): void {
    this.loadAllData();
  }

  onPageShow(): void {
    this.loadAllData();
  }

  private loadAllData(): void {
    this.isLoading = true;
    const context = this.getUIContext().getHostContext() as common.Context;

    AuthStore.getCurrentUser(context).then(async (user: AuthUser | null) => {
      this.currentUser = user;
      let tracks: TrackModel.Track[] = await TrackStore.getTracks(context);
      let myTracks: TrackModel.Track[] = user
        ? tracks.filter((t: TrackModel.Track) => t.ownerUserId === user.userId)
        : tracks;
      // é‡è£…åŽæœ¬åœ°ä¸ºç©ºæ—¶ï¼Œä»Žäº‘ç«¯æ¢å¤ã€Œæˆ‘çš„è½¨è¿¹ã€
      if (user && myTracks.length === 0) {
        await SyncService.restoreMyTracksFromCloud(context);
        tracks = await TrackStore.getTracks(context);
        myTracks = tracks.filter((t: TrackModel.Track) => t.ownerUserId === user.userId);
      }
      this.myTracks = myTracks;
      this.myTracksDisplayCount = Math.min(MY_TRACKS_PAGE_SIZE, myTracks.length);
      this.publicTracks = tracks.filter((t: TrackModel.Track) =>
        t.visibility === TrackModel.VISIBILITY_PUBLIC && t.status === TrackModel.TRACK_STATUS_DONE
      );
      this.publicTracksDisplayCount = Math.min(MY_TRACKS_PAGE_SIZE, this.publicTracks.length);
      this.isLoading = false;

      // è¿›å…¥é¦–é¡µæ—¶ï¼ŒåŽå°åŒæ­¥æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
      SyncService.syncAll(context).catch((e: Error) => {
        hilog.warn(LOG_DOMAIN, LOG_TAG, 'Background sync: %{public}s', JSON.stringify(e));
      });
    }).catch(() => {
      this.isLoading = false;
    });
  }

  /** è®¡ç®—ç»Ÿè®¡ */
  private getTrackCount(): number {
    return this.myTracks.length;
  }

  private getSpotCount(): number {
    let count = 0;
    for (let i = 0; i < this.myTracks.length; i++) {
      count += this.myTracks[i].spotCount || 0;
    }
    return count;
  }

  private getTotalDistance(): string {
    let total = 0;
    for (let i = 0; i < this.myTracks.length; i++) {
      total += this.myTracks[i].totalDistance;
    }
    return TrackModel.formatDistance(total);
  }

  build() {
    Tabs({ barPosition: BarPosition.End, index: this.currentBottomIndex }) {
      TabContent() {
        this.HomeTabContent();
      }
      .tabBar(this.BottomTabItem(0, 'é¦–é¡µ', 'ðŸ '));

      TabContent() {
        this.ProfileTabContent();
      }
      .tabBar(this.BottomTabItem(1, 'ä¸ªäººä¸­å¿ƒ', 'ðŸ‘¤'));
    }
    .barMode(BarMode.Fixed)
    .barHeight(56 + this.bottomSafeHeight)
    .barBackgroundColor($r('app.color.tab_bar_background'))
    .onChange((index: number) => {
      this.currentBottomIndex = index;
    })
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }

  // ==================== é¦–é¡µ Tab ====================
  @Builder
  HomeTabContent() {
    Column() {
      // çŠ¶æ€æ å ä½ + æ ‡é¢˜åŒºï¼ˆç™½è‰²èƒŒæ™¯ï¼‰
      Column() {
        Row()
          .width('100%')
          .height(this.statusBarHeight);
        Row({ space: 12 }) {
          Text($r('app.string.app_name'))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.label_primary'));
          Blank();
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 4 });
      }
      .width('100%')
      .backgroundColor(Color.White);

      // é¡¶éƒ¨ Tab åˆ‡æ¢
      Tabs({ barPosition: BarPosition.Start, index: this.currentTopIndex }) {
        TabContent() {
          this.MyTracksList();
        }
        .tabBar(this.TopTabItem(0, $r('app.string.tab_my_tracks')));

        TabContent() {
          this.PublicTracksList();
        }
        .tabBar(this.TopTabItem(1, $r('app.string.tab_all_tracks')));
      }
      .barMode(BarMode.Fixed)
      .barHeight(44)
      .barBackgroundColor(Color.White)
      .onChange((index: number) => {
        this.currentTopIndex = index;
      })
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }

  @Builder
  TopTabItem(index: number, title: string | Resource) {
    Column() {
      Text(title)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentTopIndex === index ? $r('app.color.primary') : $r('app.color.label_tertiary'));
      // å§‹ç»ˆæ¸²æŸ“æŒ‡ç¤ºçº¿ï¼Œæœªé€‰ä¸­æ—¶é€æ˜Žï¼Œé¿å…å¸ƒå±€æŠ–åŠ¨
      Column()
        .width(24)
        .height(3)
        .backgroundColor($r('app.color.primary'))
        .borderRadius(1.5)
        .margin({ top: 6 })
        .opacity(this.currentTopIndex === index ? 1 : 0);
    }
    .padding({ top: 8, bottom: 4 });
  }

  @Builder
  BottomTabItem(index: number, title: string, icon: string) {
    Column({ space: 2 }) {
      Text(icon)
        .fontSize(22);
      Text(title)
        .fontSize(10)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentBottomIndex === index ? $r('app.color.primary') : $r('app.color.label_tertiary'));
    }
    .padding({ top: 6, bottom: 6 })
    .layoutWeight(1);
  }

  // ==================== æˆ‘çš„è½¨è¿¹åˆ—è¡¨ ====================
  @Builder
  MyTracksList() {
    Column() {
      if (this.myTracks.length > 0) {
        List({ space: 12 }) {
          // æ–°å»ºæŒ‰é’®
          ListItem() {
            Row({ space: 6 }) {
              Text('+')
                .fontSize(18)
                .fontColor($r('app.color.primary'));
              Text($r('app.string.main_new_track_btn'))
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.primary'));
            }
            .width('100%')
            .height(48)
            .justifyContent(FlexAlign.Center)
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(12)
            .borderWidth(2)
            .borderColor($r('app.color.primary'))
            .borderStyle(BorderStyle.Dashed)
            .onClick(() => {
              this.getUIContext().getRouter().pushUrl({ url: 'pages/CreateOrEditTrack' });
            });
          }
          .margin({ left: 16, right: 16 });

          // è½¨è¿¹å¡ç‰‡åˆ—è¡¨ï¼ˆåˆ†é¡µå±•ç¤ºï¼Œé¿å…ä¸€æ¬¡æ¸²æŸ“è¿‡å¤šï¼‰
          ForEach(this.myTracks.slice(0, this.myTracksDisplayCount), (item: TrackModel.Track) => {
            ListItem() {
              this.TrackCard(item);
            }
            .margin({ left: 16, right: 16 });
          }, (item: TrackModel.Track) => item.trackId);

          // åŠ è½½æ›´å¤š
          if (this.myTracksDisplayCount < this.myTracks.length) {
            ListItem() {
              Row() {
                Text('åŠ è½½æ›´å¤šï¼ˆ' + (this.myTracks.length - this.myTracksDisplayCount).toString() + ' æ¡ï¼‰')
                  .fontSize(14)
                  .fontColor($r('app.color.primary'));
              }
              .width('100%')
              .height(48)
              .justifyContent(FlexAlign.Center)
              .onClick(() => {
                this.myTracksDisplayCount = Math.min(
                  this.myTracksDisplayCount + MY_TRACKS_PAGE_SIZE,
                  this.myTracks.length
                );
              });
            }
            .margin({ left: 16, right: 16 });
          }
        }
        .layoutWeight(1)
        .width('100%')
        .padding({ top: 12, bottom: 16 })
        .scrollBar(BarState.Off);
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 12 }) {
          Text('ðŸ“')
            .fontSize(48);
          Text($r('app.string.empty_my_tracks_title'))
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.label_primary'));
          Text($r('app.string.empty_my_tracks_hint'))
            .fontSize(14)
            .fontColor($r('app.color.label_tertiary'))
            .textAlign(TextAlign.Center)
            .lineHeight(22);
          Button($r('app.string.empty_my_tracks_action'))
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
            .backgroundColor($r('app.color.primary'))
            .height(48)
            .padding({ left: 32, right: 32 })
            .borderRadius(24)
            .margin({ top: 8 })
            .onClick(() => {
              this.getUIContext().getRouter().pushUrl({ url: 'pages/CreateOrEditTrack' });
            });
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .width('100%');
      }
    }
    .width('100%')
    .height('100%');
  }

  @Builder
  StatsItem(value: string, label: string) {
    Column({ space: 2 }) {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White);
      Text(label)
        .fontSize(11)
        .fontColor('#CCFFFFFF');
    }
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center);
  }

  @Builder
  TrackCard(item: TrackModel.Track) {
    Column() {
      // å°é¢å›¾ï¼ˆå¦‚æœ‰ï¼‰
      if (item.coverImageUrl.length > 0) {
        Image(item.coverImageUrl)
          .width('100%')
          .height(140)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 12, topRight: 12 })
          .alt($r('app.color.separator'));
      }

      Column() {
        Row({ space: 8 }) {
          Text(item.title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.label_primary'))
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis });
          if (item.status === TrackModel.TRACK_STATUS_DONE) {
            Text($r('app.string.status_done'))
              .fontSize(11)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.success'))
              .backgroundColor($r('app.color.success_light'))
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(10);
          } else {
            Text($r('app.string.status_editing'))
              .fontSize(11)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.warning'))
              .backgroundColor($r('app.color.warning_light'))
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(10);
          }
        }
        .width('100%');

        Text(TrackModel.formatDate(item.createdAt))
          .fontSize(12)
          .fontColor($r('app.color.label_tertiary'))
          .margin({ top: 4 });

        if (item.description.length > 0) {
          Text(item.description)
            .fontSize(13)
            .fontColor($r('app.color.label_secondary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 });
        }

        Row({ space: 16 }) {
          Text('ðŸ“ ' + TrackModel.formatDistance(item.totalDistance))
            .fontSize(12)
            .fontColor($r('app.color.label_secondary'));
          if (item.maxAltitude > 0) {
            Text('â›° ' + item.maxAltitude.toString() + 'm')
              .fontSize(12)
              .fontColor($r('app.color.label_secondary'));
          }
          if (item.totalDuration > 0) {
            Text('â± ' + TrackModel.formatDuration(item.totalDuration))
              .fontSize(12)
              .fontColor($r('app.color.label_secondary'));
          }
        }
        .width('100%')
        .margin({ top: 8 });
      }
      .width('100%')
      .padding(item.coverImageUrl.length > 0 ? { left: 16, right: 16, top: 12, bottom: 16 } :
        { left: 16, right: 16, top: 16, bottom: 16 });
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetX: 0, offsetY: 2 })
    .clip(true)
    .onClick(() => {
      this.getUIContext().getRouter().pushUrl({
        url: 'pages/TrackDetail',
        params: { trackId: item.trackId, title: item.title }
      });
    });
  }

  // ==================== å…¬å¼€è½¨è¿¹åˆ—è¡¨ ====================
  @Builder
  PublicTracksList() {
    Column() {
      if (this.publicTracks.length > 0) {
        List({ space: 12 }) {
          ForEach(this.publicTracks.slice(0, this.publicTracksDisplayCount), (item: TrackModel.Track) => {
            ListItem() {
              this.PublicTrackCard(item);
            }
            .margin({ left: 16, right: 16 });
          }, (item: TrackModel.Track) => item.trackId);
          if (this.publicTracksDisplayCount < this.publicTracks.length) {
            ListItem() {
              Row() {
                Text('åŠ è½½æ›´å¤šï¼ˆ' + (this.publicTracks.length - this.publicTracksDisplayCount).toString() + ' æ¡ï¼‰')
                  .fontSize(14)
                  .fontColor($r('app.color.primary'));
              }
              .width('100%')
              .height(48)
              .justifyContent(FlexAlign.Center)
              .onClick(() => {
                this.publicTracksDisplayCount = Math.min(
                  this.publicTracksDisplayCount + MY_TRACKS_PAGE_SIZE,
                  this.publicTracks.length
                );
              });
            }
            .margin({ left: 16, right: 16 });
          }
        }
        .layoutWeight(1)
        .width('100%')
        .padding({ top: 12, bottom: 16 })
        .scrollBar(BarState.Off);
      } else {
        Column({ space: 12 }) {
          Text('ðŸŒ')
            .fontSize(48);
          Text($r('app.string.empty_all_tracks_title'))
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.label_primary'));
          Text($r('app.string.empty_all_tracks_hint'))
            .fontSize(14)
            .fontColor($r('app.color.label_tertiary'));
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .width('100%');
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }

  @Builder
  PublicTrackCard(item: TrackModel.Track) {
    Column() {
      Row({ space: 8 }) {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.label_primary'))
          .layoutWeight(1)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis });
        Text($r('app.string.visibility_public'))
          .fontSize(11)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.primary'))
          .backgroundColor($r('app.color.menu_selected_bg'))
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(10);
      }
      .width('100%');

      // ä½œè€…ä¿¡æ¯
      Row({ space: 4 }) {
        Text('ðŸ‘¤')
          .fontSize(11);
        Text(item.ownerDisplayName && item.ownerDisplayName.length > 0 ? item.ownerDisplayName : $r('app.string.profile_default_user'))
          .fontSize(12)
          .fontColor($r('app.color.label_secondary'));
        Text('Â·')
          .fontSize(12)
          .fontColor($r('app.color.label_tertiary'));
        Text(TrackModel.formatDate(item.createdAt))
          .fontSize(12)
          .fontColor($r('app.color.label_tertiary'));
      }
      .width('100%')
      .margin({ top: 4 });

      if (item.description.length > 0) {
        Text(item.description)
          .fontSize(13)
          .fontColor($r('app.color.label_secondary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 });
      }

      Row({ space: 16 }) {
        Text('ðŸ“ ' + TrackModel.formatDistance(item.totalDistance))
          .fontSize(12)
          .fontColor($r('app.color.label_secondary'));
        if (item.spotCount > 0) {
          Text('ðŸ ' + item.spotCount.toString() + 'ä¸ªæ‰“å¡ç‚¹')
            .fontSize(12)
            .fontColor($r('app.color.label_secondary'));
        }
        if (item.maxAltitude > 0) {
          Text('â›° ' + item.maxAltitude.toString() + 'm')
            .fontSize(12)
            .fontColor($r('app.color.label_secondary'));
        }
      }
      .width('100%')
      .margin({ top: 8 });
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetX: 0, offsetY: 2 })
    .onClick(() => {
      this.getUIContext().getRouter().pushUrl({
        url: 'pages/TrackDetail',
        params: { trackId: item.trackId, title: item.title, isPublicView: true }
      });
    });
  }

  // ==================== ä¸ªäººä¸­å¿ƒ ====================
  @Builder
  ProfileTabContent() {
    Column() {
      // å¤´éƒ¨
      Column({ space: 12 }) {
        if (this.currentUser && this.currentUser.avatarUrl.length > 0) {
          Image(this.currentUser.avatarUrl)
            .width(72)
            .height(72)
            .borderRadius(36)
            .objectFit(ImageFit.Cover);
        } else {
          Column() {
            Text('ðŸ‘¤')
              .fontSize(32);
          }
          .width(72)
          .height(72)
          .borderRadius(36)
          .backgroundColor($r('app.color.menu_item_inactive'))
          .justifyContent(FlexAlign.Center);
        }
        Text(this.currentUser && this.currentUser.displayName.length > 0 ?
          this.currentUser.displayName : $r('app.string.profile_default_user'))
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White);
        if (this.currentUser && this.currentUser.familyName.length > 0) {
          Text(this.currentUser.familyName)
            .fontSize(13)
            .fontColor($r('app.color.login_title_secondary'));
        }

        // ç»Ÿè®¡
        Row() {
          Column({ space: 2 }) {
            Text(this.getTrackCount().toString())
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White);
            Text($r('app.string.main_stat_tracks'))
              .fontSize(11)
              .fontColor($r('app.color.login_button_secondary'));
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center);

          Column().width(1).height(30).backgroundColor($r('app.color.menu_divider'));

          Column({ space: 2 }) {
            Text(this.getSpotCount().toString())
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White);
            Text($r('app.string.main_stat_spots'))
              .fontSize(11)
              .fontColor($r('app.color.login_button_secondary'));
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center);

          Column().width(1).height(30).backgroundColor($r('app.color.menu_divider'));

          Column({ space: 2 }) {
            Text(this.getTotalDistance())
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White);
            Text($r('app.string.main_stat_total_distance'))
              .fontSize(11)
              .fontColor($r('app.color.login_button_secondary'));
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center);
        }
        .width('100%')
        .padding(12)
        .backgroundColor($r('app.color.icon_overlay_light'))
        .borderRadius(12)
        .margin({ top: 8 });
      }
      .width('100%')
      .padding({ top: 16 + this.statusBarHeight, bottom: 24, left: 20, right: 20 })
      .linearGradient({
        angle: 160,
        colors: [[$r('app.color.primary'), 0], [$r('app.color.primary_dark'), 0.5], [$r('app.color.gradient_end'), 1]]
      })
      .alignItems(HorizontalAlign.Center);

      // èœå•
      Column({ space: 12 }) {
        Column() {
          this.MenuItem('ðŸ‘¤', $r('app.string.menu_edit_profile'), '', $r('app.color.primary'), () => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/ProfileEdit' });
          });
        }
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetX: 0, offsetY: 2 });

        Column() {
          this.MenuItem('ðŸ“„', $r('app.string.menu_privacy'), '', $r('app.color.success'), () => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/PrivacyPolicy' });
          });
          Divider().color($r('app.color.separator')).margin({ left: 56, right: 16 });
          this.MenuItem('ðŸ“‹', $r('app.string.menu_user_agreement'), '', $r('app.color.success'), () => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/UserAgreement' });
          });
          Divider().color($r('app.color.separator')).margin({ left: 56, right: 16 });
          this.MenuItem('â„¹', $r('app.string.menu_about'), 'V1.0', $r('app.color.primary'), () => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/About' });
          });
          Divider().color($r('app.color.separator')).margin({ left: 56, right: 16 });
          this.MenuItem('ðŸ’¬', $r('app.string.menu_feedback'), '', $r('app.color.destructive'), () => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/Feedback' });
          });
        }
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetX: 0, offsetY: 2 });

        // å¼€å‘è°ƒè¯•ï¼šCloud DB è¯Šæ–­
        Column({ space: 8 }) {
          Button(this.isDiagnosing ? 'è¯Šæ–­ä¸­...' : 'ðŸ”§ è¯Šæ–­ Cloud DB è¿žé€šæ€§')
            .width('100%')
            .height(48)
            .fontSize(14)
            .fontColor($r('app.color.primary'))
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(12)
            .enabled(!this.isDiagnosing)
            .onClick(() => {
              this.isDiagnosing = true;
              this.diagResult = '';
              CloudDBService.diagnose().then((result: string) => {
                this.diagResult = result;
                this.isDiagnosing = false;
              }).catch((e: Error) => {
                this.diagResult = 'âŒ è¯Šæ–­å¼‚å¸¸: ' + JSON.stringify(e);
                this.isDiagnosing = false;
              });
            });

          if (this.diagResult.length > 0) {
            Text(this.diagResult)
              .fontSize(12)
              .fontColor($r('app.color.label_secondary'))
              .width('100%')
              .padding(12)
              .backgroundColor($r('app.color.layer_inactive_bg'))
              .borderRadius(8);
          }
        }

        Button($r('app.string.profile_logout'))
          .width('100%')
          .height(48)
          .fontSize(15)
          .fontColor($r('app.color.destructive'))
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(12)
          .shadow({ radius: 4, color: '#0D000000', offsetX: 0, offsetY: 2 })
          .onClick(() => {
            this.getUIContext().getPromptAction().showDialog({
              message: $r('app.string.confirm_logout'),
              buttons: [
                { text: $r('app.string.dialog_cancel'), color: $r('app.color.dialog_secondary_text') },
                { text: $r('app.string.dialog_confirm'), color: $r('app.color.destructive') }
              ]
            }).then((result: promptAction.ShowDialogSuccessResponse) => {
              if (result.index === 1) {
                const ctx = this.getUIContext().getHostContext() as common.Context;
                AuthStore.clearUser(ctx).then(() => {
                  this.getUIContext().getRouter().replaceUrl({ url: 'pages/Login' });
                });
              }
            }).catch(() => {});
          });
      }
      .width('100%')
      .padding(16)
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }

  @Builder
  MenuItem(icon: string, title: string | Resource, value: string, iconBgColor: string | Resource, onClick: () => void) {
    Row() {
      Column() {
        Text(icon)
          .fontSize(16);
      }
      .width(32)
      .height(32)
      .borderRadius(8)
      .backgroundColor(iconBgColor)
      .justifyContent(FlexAlign.Center);
      Text(title)
        .fontSize(15)
        .fontColor($r('app.color.label_primary'))
        .layoutWeight(1)
        .margin({ left: 12 });
      if (value.length > 0) {
        Text(value)
          .fontSize(13)
          .fontColor($r('app.color.label_tertiary'))
          .margin({ right: 8 });
      }
      Text('â€º')
        .fontSize(18)
        .fontColor($r('app.color.label_tertiary'));
    }
    .width('100%')
    .height(52)
    .padding({ left: 16, right: 16 })
    .onClick(onClick);
  }
}

import { common } from '@kit.AbilityKit';
import { NavBar } from '../common/NavBar';
import { TrackStore } from '../common/TrackStore';
import { TrackModel } from '../common/TrackModel';
import { AuthStore } from '../common/AuthStore';

/**
 * P1-2 新建轨迹基础信息页
 * 填写名称和简介，保存后跳转到轨迹记录页
 */
@Entry
@Component
struct CreateOrEditTrack {
  @State title: string = '';
  @State description: string = '';
  @State isSaving: boolean = false;

  private async saveAndStartRecord(): Promise<void> {
    if (this.title.trim().length === 0 || this.isSaving) {
      return;
    }
    this.isSaving = true;

    const context = this.getUIContext().getHostContext() as common.Context;
    const user = await AuthStore.getCurrentUser(context);
    const userId = user ? user.userId : '';

    const trackId = TrackModel.generateId('track');
    const now = Date.now();
    const displayName = user ? user.displayName : '';
    const track: TrackModel.Track = {
      trackId: trackId,
      ownerUserId: userId,
      ownerDisplayName: displayName,
      title: this.title.trim(),
      description: this.description.trim(),
      visibility: TrackModel.VISIBILITY_PRIVATE,
      status: TrackModel.TRACK_STATUS_EDITING,
      startName: '',
      endName: '',
      startLat: 0,
      startLng: 0,
      endLat: 0,
      endLng: 0,
      totalDistance: 0,
      totalDuration: 0,
      maxAltitude: 0,
      spotCount: 0,
      coverImageUrl: '',
      createdAt: now,
      updatedAt: now
    };

    await TrackStore.saveTrack(context, track);

    try {
      this.getUIContext().getRouter().replaceUrl({
        url: 'pages/TrackRecord',
        params: { trackId: trackId, title: this.title.trim() }
      });
    } catch (_e) {
      console.error('CreateOrEditTrack router.replace failed: ' + JSON.stringify(_e));
    }
  }

  build() {
    Column() {
      NavBar({ title: '新建轨迹', showBack: true });

      Scroll() {
        Column({ space: 14 }) {
          // 提示（整体上移，减少顶部留白）
          Row({ space: 8 }) {
            Text($r('app.string.create_track_tip_icon'))
              .fontSize(14);
            Text($r('app.string.create_track_desc_tip_full'))
              .fontSize(12)
              .fontColor($r('app.color.primary'))
              .lineHeight(18)
              .layoutWeight(1);
          }
          .width('100%')
          .padding(10)
          .backgroundColor($r('app.color.primary_light'))
          .borderRadius(10);

          // 轨迹名称
          Column({ space: 4 }) {
            Row() {
              Text($r('app.string.create_track_name_label'))
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.label_secondary'));
              Text($r('app.string.create_track_required'))
                .fontSize(13)
                .fontColor($r('app.color.destructive'));
            }
            TextInput({ placeholder: '例如：刘氏家族清明扫墓', text: this.title })
              .onChange((value: string) => {
                this.title = value;
              })
              .width('100%')
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(10)
              .padding({ left: 12, right: 12 })
              .borderWidth(1.5)
              .borderColor($r('app.color.separator'));
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start);

          // 轨迹简介
          Column({ space: 4 }) {
            Text($r('app.string.create_track_desc_label'))
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.label_secondary'));
            TextArea({ placeholder: '简要描述本次扫墓的目的、参与人员等', text: this.description })
              .onChange((value: string) => {
                this.description = value;
              })
              .width('100%')
              .height(72)
              .fontSize(16)
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(10)
              .padding(12)
              .borderWidth(1.5)
              .borderColor($r('app.color.separator'));
            Text($r('app.string.create_track_desc_tip_short'))
              .fontSize(11)
              .fontColor($r('app.color.label_tertiary'));
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start);
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 0, bottom: 16 });
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Off)
      .backgroundColor($r('app.color.app_background'));

      // 底部按钮
      Column() {
        Button(this.isSaving ? '保存中…' : '保存并开始记录')
          .width('100%')
          .height(46)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .backgroundColor($r('app.color.primary'))
          .borderRadius(23)
          .enabled(this.title.trim().length > 0 && !this.isSaving)
          .opacity(this.title.trim().length > 0 && !this.isSaving ? 1 : 0.5)
          .onClick(() => {
            this.saveAndStartRecord();
          });
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 8, bottom: 20 })
      .backgroundColor($r('app.color.card_background'))
      .shadow({ radius: 6, color: $r('app.color.shadow_light'), offsetX: 0, offsetY: -2 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }
}

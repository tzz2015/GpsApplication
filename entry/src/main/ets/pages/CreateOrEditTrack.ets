import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { NavBar } from '../common/NavBar';
import { TrackStore } from '../common/TrackStore';
import { TrackModel } from '../common/TrackModel';
import { AuthStore } from '../common/AuthStore';

/**
 * P1-2 æ–°å»ºè½¨è¿¹åŸºç¡€ä¿¡æ¯é¡µ
 * å¡«å†™åç§°å’Œç®€ä»‹ï¼Œä¿å­˜åè·³è½¬åˆ°è½¨è¿¹è®°å½•é¡µ
 */
@Entry
@Component
struct CreateOrEditTrack {
  @State title: string = '';
  @State description: string = '';
  @State isSaving: boolean = false;

  private async saveAndStartRecord(): Promise<void> {
    if (this.title.trim().length === 0 || this.isSaving) {
      return;
    }
    this.isSaving = true;

    const context = this.getUIContext().getHostContext() as common.Context;
    const user = await AuthStore.getCurrentUser(context);
    const userId = user ? user.userId : '';

    const trackId = TrackModel.generateId('track');
    const now = Date.now();
    const displayName = user ? user.displayName : '';
    const track: TrackModel.Track = {
      trackId: trackId,
      ownerUserId: userId,
      ownerDisplayName: displayName,
      title: this.title.trim(),
      description: this.description.trim(),
      visibility: TrackModel.VISIBILITY_PRIVATE,
      status: TrackModel.TRACK_STATUS_EDITING,
      startName: '',
      endName: '',
      startLat: 0,
      startLng: 0,
      endLat: 0,
      endLng: 0,
      totalDistance: 0,
      totalDuration: 0,
      maxAltitude: 0,
      spotCount: 0,
      coverImageUrl: '',
      createdAt: now,
      updatedAt: now
    };

    await TrackStore.saveTrack(context, track);

    try {
      router.replace({
        url: 'pages/TrackRecord',
        params: { trackId: trackId, title: this.title.trim() }
      });
    } catch (_e) {
      console.error('CreateOrEditTrack router.replace failed: ' + JSON.stringify(_e));
    }
  }

  build() {
    Column() {
      NavBar({ title: 'æ–°å»ºè½¨è¿¹', showBack: true });

      Scroll() {
        Column({ space: 14 }) {
          // æç¤º
          Row({ space: 8 }) {
            Text('ğŸ’¡')
              .fontSize(14);
            Text('å»ºè®®å¡«å†™æœ¬æ¬¡æ‰«å¢“çš„åœ°åŒºã€ä¸»è¦ç¥–å…ˆå§“æ°ã€æ—¥æœŸç­‰ä¿¡æ¯ï¼Œæ–¹ä¾¿æ—¥åæŸ¥æ‰¾ã€‚')
              .fontSize(12)
              .fontColor($r('app.color.primary'))
              .lineHeight(18)
              .layoutWeight(1);
          }
          .width('100%')
          .padding(10)
          .backgroundColor($r('app.color.primary_light'))
          .borderRadius(10);

          // è½¨è¿¹åç§°
          Column({ space: 4 }) {
            Row() {
              Text('è½¨è¿¹åç§°')
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.label_secondary'));
              Text(' *')
                .fontSize(13)
                .fontColor($r('app.color.destructive'));
            }
            TextInput({ placeholder: 'ä¾‹å¦‚ï¼šåˆ˜æ°å®¶æ—æ¸…æ˜æ‰«å¢“', text: this.title })
              .onChange((value: string) => {
                this.title = value;
              })
              .width('100%')
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(10)
              .padding({ left: 12, right: 12 })
              .borderWidth(1.5)
              .borderColor($r('app.color.separator'));
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start);

          // è½¨è¿¹ç®€ä»‹
          Column({ space: 4 }) {
            Text('è½¨è¿¹ç®€ä»‹')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.label_secondary'));
            TextArea({ placeholder: 'ç®€è¦æè¿°æœ¬æ¬¡æ‰«å¢“çš„ç›®çš„ã€å‚ä¸äººå‘˜ç­‰', text: this.description })
              .onChange((value: string) => {
                this.description = value;
              })
              .width('100%')
              .height(72)
              .fontSize(16)
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(10)
              .padding(12)
              .borderWidth(1.5)
              .borderColor($r('app.color.separator'));
            Text('å»ºè®®è¯´æ˜æœ¬æ¬¡æ‰«å¢“çš„åœ°åŒºã€ä¸»è¦ç¥–å…ˆã€æ—¥æœŸç­‰')
              .fontSize(11)
              .fontColor($r('app.color.label_tertiary'));
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start);
        }
        .width('100%')
        .padding(16);
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Off)
      .backgroundColor($r('app.color.app_background'));

      // åº•éƒ¨æŒ‰é’®
      Column() {
        Button(this.isSaving ? 'ä¿å­˜ä¸­â€¦' : 'ä¿å­˜å¹¶å¼€å§‹è®°å½•')
          .width('100%')
          .height(46)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .backgroundColor($r('app.color.primary'))
          .borderRadius(23)
          .enabled(this.title.trim().length > 0 && !this.isSaving)
          .opacity(this.title.trim().length > 0 && !this.isSaving ? 1 : 0.5)
          .onClick(() => {
            this.saveAndStartRecord();
          });
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 8, bottom: 20 })
      .backgroundColor($r('app.color.card_background'))
      .shadow({ radius: 6, color: '#0D000000', offsetX: 0, offsetY: -2 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.app_background'));
  }
}

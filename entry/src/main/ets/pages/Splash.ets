import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { AuthStore } from '../common/AuthStore';

/**
 * P0-1 å¯åŠ¨é¡µ / å†·å¯åŠ¨é¡µ
 * å±•ç¤º App Logoã€åç§°å’Œæ ‡è¯­ï¼Œ2.5 ç§’åŽè‡ªåŠ¨è·³è½¬ï¼š
 *   - å·²ç™»å½• â†’ é¦–é¡µ Main
 *   - æœªç™»å½• â†’ ç™»å½•é¡µ Login
 */
@Entry
@Component
struct Splash {
  @State showHint: boolean = false;
  private timerId: number = -1;

  aboutToAppear(): void {
    // å»¶è¿Ÿæ˜¾ç¤ºåº•éƒ¨æç¤ºæ–‡å­—
    setTimeout(() => {
      this.showHint = true;
    }, 500);

    // 1 ç§’åŽè‡ªåŠ¨è·³è½¬
    this.timerId = setTimeout(() => {
      this.navigateNext();
    }, 1000);
  }

  aboutToDisappear(): void {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
    }
  }

  /** æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·³è½¬ */
  private navigateNext(): void {
    const context = getContext(this) as common.UIAbilityContext;
    AuthStore.isLoggedIn(context).then((loggedIn: boolean) => {
      const target = loggedIn ? 'pages/Main' : 'pages/Login';
      router.replaceUrl({ url: target });
    }).catch(() => {
      router.replaceUrl({ url: 'pages/Login' });
    });
  }

  build() {
    Column() {
      Blank().layoutWeight(1);

      // Logo
      Column() {
        Text('ðŸ”ï¸')
          .fontSize(42);
      }
      .width(80)
      .height(80)
      .borderRadius(20)
      .backgroundColor('#22FFFFFF')
      .justifyContent(FlexAlign.Center)
      .backdropBlur(20);

      // App åç§°
      Text('é¨æ¸¸è½¨è¿¹')
        .fontSize(28)
        .fontWeight(800)
        .fontColor(Color.White)
        .letterSpacing(2)
        .margin({ top: 20 });

      // æ ‡è¯­
      Text('è®°å½•æ¯ä¸€æ®µå€¼å¾—ä¼ æ‰¿çš„è·¯ç¨‹')
        .fontSize(14)
        .fontColor('#CCFFFFFF')
        .margin({ top: 8 });

      Blank().layoutWeight(1);

      // åº•éƒ¨æç¤º
      if (this.showHint) {
        Text('ç‚¹å‡»è¿›å…¥ â†’')
          .fontSize(13)
          .fontColor('#66FFFFFF')
          .margin({ bottom: 60 })
          .onClick(() => {
            if (this.timerId !== -1) {
              clearTimeout(this.timerId);
              this.timerId = -1;
            }
            this.navigateNext();
          });
      }
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 160,
      colors: [['#2E5AE8', 0], ['#1A3DB8', 0.5], ['#0F2680', 1]]
    })
    .alignItems(HorizontalAlign.Center)
    .justifyContent(FlexAlign.Center);
  }
}

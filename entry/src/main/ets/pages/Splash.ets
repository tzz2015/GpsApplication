import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { AuthStore } from '../common/AuthStore';

/**
 * P0-1 å¯åŠ¨é¡µ / å†·å¯åŠ¨é¡µ
 * å±•ç¤º App Logoã€åç§°å’Œæ ‡è¯­ï¼Œ1 ç§’åŽè‡ªåŠ¨è·³è½¬
 */
@Entry
@Component
struct Splash {
  @State showHint: boolean = false;
  private timerId: number = -1;

  aboutToAppear(): void {
    setTimeout(() => {
      this.showHint = true;
    }, 500);

    this.timerId = setTimeout(() => {
      this.navigateNext();
    }, 1000);
  }

  aboutToDisappear(): void {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
    }
  }

  private navigateNext(): void {
    const context = this.getUIContext().getHostContext() as common.Context;
    AuthStore.isLoggedIn(context).then((loggedIn: boolean) => {
      const target = loggedIn ? 'pages/Main' : 'pages/Login';
      router.replace({ url: target });
    }).catch(() => {
      router.replace({ url: 'pages/Login' });
    });
  }

  build() {
    Stack() {
      // å±…ä¸­å†…å®¹ï¼ˆå›ºå®šåœ¨æ­£ä¸­ï¼Œä¸å—åº•éƒ¨æç¤ºå½±å“ï¼‰
      Column({ space: 0 }) {
        Column() {
          Text('ðŸ”ï¸')
            .fontSize(42);
        }
        .width(80)
        .height(80)
        .borderRadius(20)
        .backgroundColor('#22FFFFFF')
        .justifyContent(FlexAlign.Center)
        .backdropBlur(20);

        Text('é¨æ¸¸è½¨è¿¹')
          .fontSize(28)
          .fontWeight(800)
          .fontColor(Color.White)
          .letterSpacing(2)
          .margin({ top: 20 });

        Text('è®°å½•æ¯ä¸€æ®µå€¼å¾—ä¼ æ‰¿çš„è·¯ç¨‹')
          .fontSize(14)
          .fontColor('#CCFFFFFF')
          .margin({ top: 8 });
      }
      .alignItems(HorizontalAlign.Center);

      // åº•éƒ¨æç¤ºï¼ˆç»å¯¹å®šä½ï¼Œä¸å½±å“ä¸­é—´å¸ƒå±€ï¼‰
      if (this.showHint) {
        Text('ç‚¹å‡»è¿›å…¥ â†’')
          .fontSize(13)
          .fontColor('#66FFFFFF')
          .position({ bottom: 60 })
          .width('100%')
          .textAlign(TextAlign.Center)
          .onClick(() => {
            if (this.timerId !== -1) {
              clearTimeout(this.timerId);
              this.timerId = -1;
            }
            this.navigateNext();
          });
      }
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .linearGradient({
      angle: 160,
      colors: [['#2E5AE8', 0], ['#1A3DB8', 0.5], ['#0F2680', 1]]
    });
  }
}

import { LoginWithHuaweiIDButton, loginComponentManager } from '@kit.AccountKit';
import { abilityAccessCtrl, common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { AuthStore } from '../common/AuthStore';
import { HuaweiAuthHelper, UserInfo } from '../common/HuaweiAuthHelper';
import { Config } from '../common/Config';
import { SyncService } from '../common/SyncService';

const LOG_DOMAIN = 0x0000;
const LOG_TAG = 'Login';

/**
 * ç™»å½•é¡µï¼šä½¿ç”¨å®˜æ–¹ LoginWithHuaweiIDButton ç»„ä»¶ï¼ˆä¸ªäººå¼€å‘è€…å¯ç”¨ï¼‰
 */
@Entry
@Component
struct Login {
  @StorageProp('bottomSafeHeight') bottomSafeHeight: number = 0;
  @State agreed: boolean = false;
  @State isLoggingIn: boolean = false;
  @State loginError: string = '';

  /** åŽä¸ºè´¦å·ç™»å½•æŒ‰é’®æŽ§åˆ¶å™¨ */
  controller: loginComponentManager.LoginWithHuaweiIDButtonController =
    new loginComponentManager.LoginWithHuaweiIDButtonController()
      /**
       * å½“åè®®çŠ¶æ€å˜åŒ–æ—¶ï¼Œéœ€é€šè¿‡ controller é€šçŸ¥ç™»å½•æŒ‰é’®
       */
      .onClickLoginWithHuaweiIDButton(
        (error: BusinessError, credential: loginComponentManager.HuaweiIDCredential) => {
          if (error) {
            this.handleLoginError(error);
            return;
          }
          if (credential) {
            this.handleLoginCredential(credential);
          }
        });

  aboutToAppear(): void {
    this.requestPermissions();
    // åˆå§‹åŒ–åè®®çŠ¶æ€ï¼šæœªåŒæ„
    this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.NOT_ACCEPTED);
  }

  /** ç”³è¯·å®šä½ç­‰æƒé™ */
  requestPermissions(): void {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const context = this.getUIContext().getHostContext() as common.Context;
      atManager.requestPermissionsFromUser(context, [
        'ohos.permission.INTERNET',
        'ohos.permission.LOCATION',
        'ohos.permission.APPROXIMATELY_LOCATION'
      ]).then(() => {
        hilog.info(LOG_DOMAIN, LOG_TAG, 'Permissions granted');
      }).catch((err: BusinessError) => {
        hilog.error(LOG_DOMAIN, LOG_TAG, 'Request permissions fail: %{public}s', JSON.stringify(err));
      });
    } catch (e) {
      hilog.error(LOG_DOMAIN, LOG_TAG, 'requestPermissions error: %{public}s', JSON.stringify(e));
    }
  }

  /** åè®®å‹¾é€‰çŠ¶æ€å˜åŒ– */
  onAgreementChange(value: boolean): void {
    this.agreed = value;
    this.loginError = '';
    // â˜… å…³é”®ï¼šé€šçŸ¥åŽä¸ºç™»å½•æŒ‰é’®åè®®çŠ¶æ€
    if (value) {
      this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.ACCEPTED);
    } else {
      this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.NOT_ACCEPTED);
    }
  }

  /** å¤„ç†ç™»å½•å‡­è¯ï¼ˆæŒ‰é’®å›žè°ƒæˆåŠŸï¼‰ */
  handleLoginCredential(credential: loginComponentManager.HuaweiIDCredential): void {
    this.isLoggingIn = true;
    this.loginError = '';

    hilog.info(LOG_DOMAIN, LOG_TAG,
      'Login credential received, openID=%{public}s',
      credential.openID || 'none');

    // ä»Žå‡­è¯ä¸­æå–ç”¨æˆ·ä¿¡æ¯
    const user: UserInfo = HuaweiAuthHelper.extractUserInfo(credential);

    // è®¾ç½®é»˜è®¤æ˜µç§°ï¼ˆLoginWithHuaweiIDButton ä¸è¿”å›žæ˜µç§°ï¼‰
    if (user.displayName.length === 0) {
      user.displayName = 'è½¨è¿¹ç”¨æˆ·';
    }

    this.handleLoginSuccess(user);
  }

  /** å¤„ç†ç™»å½•é”™è¯¯ */
  handleLoginError(error: BusinessError): void {
    const errMsg = HuaweiAuthHelper.getErrorMessage(error);
    if (errMsg.length > 0) {
      this.loginError = errMsg;
    }
    this.isLoggingIn = false;
    hilog.error(LOG_DOMAIN, LOG_TAG, 'Login failed: %{public}s', JSON.stringify(error));
  }

  /** å¤„ç†ç™»å½•æˆåŠŸ */
  private handleLoginSuccess(user: UserInfo): void {
    try {
      const context = this.getUIContext().getHostContext() as common.Context;
      const authUser = AuthStore.createNewUser(user.userId, user.displayName, user.avatarUrl);

      AuthStore.setUser(context, authUser)
        .then(async () => {
          hilog.info(LOG_DOMAIN, LOG_TAG, 'User saved');
          // é‡è£…åŽï¼šå…ˆä»Žäº‘ç«¯æ¢å¤ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ç­‰ï¼‰ï¼Œå†åŒæ­¥æœ¬åœ°åˆ°äº‘ç«¯ï¼Œå†è¿›é¦–é¡µ
          await SyncService.restoreUserFromCloud(context);
          await SyncService.syncUser(context).catch((e: Error) => {
            hilog.warn(LOG_DOMAIN, LOG_TAG, 'Sync user after login: %{public}s', JSON.stringify(e));
          });
          this.getUIContext().getRouter().replaceUrl({ url: 'pages/Main' });
        })
        .catch((error: Error) => {
          hilog.error(LOG_DOMAIN, LOG_TAG, 'User save failed: %{public}s', JSON.stringify(error));
          this.loginError = 'ç”¨æˆ·ä¿¡æ¯ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
          this.isLoggingIn = false;
        });
    } catch (error) {
      hilog.error(LOG_DOMAIN, LOG_TAG, 'Context error: %{public}s', JSON.stringify(error));
      this.loginError = 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡è¯•';
      this.isLoggingIn = false;
    }
  }

  /** æ¨¡æ‹Ÿç™»å½•ï¼ˆä»…å¼€å‘æµ‹è¯•ï¼‰ */
  private onMockLogin(): void {
    if (!this.agreed || this.isLoggingIn) {
      return;
    }
    this.isLoggingIn = true;
    this.loginError = '';

    const context = this.getUIContext().getHostContext() as common.Context;
    const mockUser = AuthStore.createNewUser('mock_user_001', 'è½¨è¿¹ç”¨æˆ·', '');

    AuthStore.setUser(context, mockUser)
      .then(() => {
        this.getUIContext().getRouter().replaceUrl({ url: 'pages/Main' });
      })
      .catch(() => {
        this.loginError = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        this.isLoggingIn = false;
      });
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ
      Column() {
        Blank().layoutWeight(1);

        // ---- Logo å’Œæ ‡è¯­ ----
        Column({ space: 16 }) {
          Column() {
            Text('ðŸ—º')
              .fontSize(52);
          }
          .width(88)
          .height(88)
          .borderRadius(22)
          .backgroundColor('#22FFFFFF')
          .justifyContent(FlexAlign.Center)
          .backdropBlur(20)
          .shadow({ radius: 16, color: '#331A3DB8', offsetX: 0, offsetY: 6 });

          Text('é¨æ¸¸è½¨è¿¹')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White);
          Text('è®°å½•æ‰«å¢“è½¨è¿¹ï¼Œå®ˆæŠ¤å®¶æ—è®°å¿†')
            .fontSize(15)
            .fontColor('#BBFFFFFF');
        }
        .alignItems(HorizontalAlign.Center);

        Blank().layoutWeight(1);

        // ---- ç™»å½•æŒ‰é’®åŒºåŸŸ ----
        Column({ space: 16 }) {
          // é”™è¯¯æç¤º
          if (this.loginError.length > 0) {
            Text(this.loginError)
              .fontSize(13)
              .fontColor('#FF6B6B')
              .width('100%')
              .textAlign(TextAlign.Center);
          }

          // â˜… å®˜æ–¹åŽä¸ºè´¦å·ç™»å½•æŒ‰é’®ç»„ä»¶
          LoginWithHuaweiIDButton({
            params: {
              style: loginComponentManager.Style.BUTTON_RED,
              extraStyle: {
                buttonStyle: new loginComponentManager.ButtonStyle()
                  .loadingStyle({ show: this.isLoggingIn })
              },
              borderRadius: 24,
              loginType: loginComponentManager.LoginType.ID,
              supportDarkMode: true
            },
            controller: this.controller
          })
            .width('100%')
            .height(50);

          // é¦–æ¬¡ç™»å½•æç¤º
          Text('é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·')
            .fontSize(12)
            .fontColor('#88FFFFFF')
            .textAlign(TextAlign.Center)
            .width('100%');

          // å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•
          if (Config.IS_DEVELOPMENT_MODE) {
            Button('å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•')
              .width('100%')
              .height(40)
              .fontSize(14)
              .fontColor('#AAFFFFFF')
              .backgroundColor(Color.Transparent)
              .borderRadius(20)
              .enabled(this.agreed && !this.isLoggingIn)
              .onClick(() => {
                this.onMockLogin();
              });
          }
        }
        .width('85%')
        .margin({ bottom: 100 });
      }
      .width('100%')
      .height('100%');

      // ---- åº•éƒ¨åè®®å‹¾é€‰ï¼ˆç»å¯¹å®šä½åœ¨åº•éƒ¨ï¼‰ ----
      Row({ space: 6 }) {
        Checkbox()
          .select(this.agreed)
          .onChange((value: boolean) => {
            this.onAgreementChange(value);
          });
        Text('å·²é˜…è¯»å¹¶åŒæ„')
          .fontSize(12)
          .fontColor('#99FFFFFF');
        Text('ã€Šéšç§æ”¿ç­–ã€‹')
          .fontSize(12)
          .fontColor('#DDFFFFFF')
          .onClick(() => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/PrivacyPolicy' });
          });
        Text('ä¸Ž')
          .fontSize(12)
          .fontColor('#99FFFFFF');
        Text('ã€Šç”¨æˆ·åè®®ã€‹')
          .fontSize(12)
          .fontColor('#DDFFFFFF')
          .onClick(() => {
            this.getUIContext().getRouter().pushUrl({ url: 'pages/UserAgreement' });
          });
      }
      .justifyContent(FlexAlign.Center)
      .width('100%')
      .position({ bottom: 20 + this.bottomSafeHeight });
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 160,
      colors: [['#3478F6', 0], ['#1E56CC', 0.5], ['#0D3BA8', 1]]
    });
  }
}

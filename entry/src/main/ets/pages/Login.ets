import { router } from '@kit.ArkUI';
import { LoginWithHuaweiIDButton, loginComponentManager } from '@kit.AccountKit';
import { abilityAccessCtrl, common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { AuthStore } from '../common/AuthStore';
import { HuaweiAuthHelper, UserInfo } from '../common/HuaweiAuthHelper';
import { Config } from '../common/Config';

const LOG_DOMAIN = 0x0000;
const LOG_TAG = 'Login';

/**
 * ç™»å½•é¡µï¼šä½¿ç”¨å®˜æ–¹ LoginWithHuaweiIDButton ç»„ä»¶ï¼ˆä¸ªäººå¼€å‘è€…å¯ç”¨ï¼‰
 */
@Entry
@Component
struct Login {
  @State agreed: boolean = false;
  @State isLoggingIn: boolean = false;
  @State loginError: string = '';

  /** åŽä¸ºè´¦å·ç™»å½•æŒ‰é’®æŽ§åˆ¶å™¨ */
  controller: loginComponentManager.LoginWithHuaweiIDButtonController =
    new loginComponentManager.LoginWithHuaweiIDButtonController()
      /**
       * å½“åè®®çŠ¶æ€å˜åŒ–æ—¶ï¼Œéœ€é€šè¿‡ controller é€šçŸ¥ç™»å½•æŒ‰é’®
       */
      .onClickLoginWithHuaweiIDButton(
        (error: BusinessError, credential: loginComponentManager.HuaweiIDCredential) => {
          if (error) {
            this.handleLoginError(error);
            return;
          }
          if (credential) {
            this.handleLoginCredential(credential);
          }
        });

  aboutToAppear(): void {
    this.requestPermissions();
    // åˆå§‹åŒ–åè®®çŠ¶æ€ï¼šæœªåŒæ„
    this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.NOT_ACCEPTED);
  }

  /** ç”³è¯·å®šä½ç­‰æƒé™ */
  requestPermissions(): void {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const context = getContext(this) as common.UIAbilityContext;
      atManager.requestPermissionsFromUser(context, [
        'ohos.permission.INTERNET',
        'ohos.permission.LOCATION',
        'ohos.permission.APPROXIMATELY_LOCATION'
      ]).then(() => {
        hilog.info(LOG_DOMAIN, LOG_TAG, 'Permissions granted');
      }).catch((err: BusinessError) => {
        hilog.error(LOG_DOMAIN, LOG_TAG, 'Request permissions fail: %{public}s', JSON.stringify(err));
      });
    } catch (e) {
      hilog.error(LOG_DOMAIN, LOG_TAG, 'requestPermissions error: %{public}s', JSON.stringify(e));
    }
  }

  /** åè®®å‹¾é€‰çŠ¶æ€å˜åŒ– */
  onAgreementChange(value: boolean): void {
    this.agreed = value;
    this.loginError = '';
    // â˜… å…³é”®ï¼šé€šçŸ¥åŽä¸ºç™»å½•æŒ‰é’®åè®®çŠ¶æ€
    if (value) {
      this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.ACCEPTED);
    } else {
      this.controller.setAgreementStatus(loginComponentManager.AgreementStatus.NOT_ACCEPTED);
    }
  }

  /** å¤„ç†ç™»å½•å‡­è¯ï¼ˆæŒ‰é’®å›žè°ƒæˆåŠŸï¼‰ */
  handleLoginCredential(credential: loginComponentManager.HuaweiIDCredential): void {
    this.isLoggingIn = true;
    this.loginError = '';

    hilog.info(LOG_DOMAIN, LOG_TAG,
      'Login credential received, openID=%{public}s',
      credential.openID || 'none');

    // ä»Žå‡­è¯ä¸­æå–ç”¨æˆ·ä¿¡æ¯
    const user: UserInfo = HuaweiAuthHelper.extractUserInfo(credential);

    // è®¾ç½®é»˜è®¤æ˜µç§°ï¼ˆLoginWithHuaweiIDButton ä¸è¿”å›žæ˜µç§°ï¼‰
    if (user.displayName.length === 0) {
      user.displayName = 'è½¨è¿¹ç”¨æˆ·';
    }

    this.handleLoginSuccess(user);
  }

  /** å¤„ç†ç™»å½•é”™è¯¯ */
  handleLoginError(error: BusinessError): void {
    const errMsg = HuaweiAuthHelper.getErrorMessage(error);
    if (errMsg.length > 0) {
      this.loginError = errMsg;
    }
    this.isLoggingIn = false;
    hilog.error(LOG_DOMAIN, LOG_TAG, 'Login failed: %{public}s', JSON.stringify(error));
  }

  /** å¤„ç†ç™»å½•æˆåŠŸ */
  private handleLoginSuccess(user: UserInfo): void {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const authUser = AuthStore.createNewUser(user.userId, user.displayName, user.avatarUrl);

      AuthStore.setUser(context, authUser)
        .then(() => {
          hilog.info(LOG_DOMAIN, LOG_TAG, 'User saved, navigating to Main');
          router.replaceUrl({ url: 'pages/Main' });
        })
        .catch((error: Error) => {
          hilog.error(LOG_DOMAIN, LOG_TAG, 'User save failed: %{public}s', JSON.stringify(error));
          this.loginError = 'ç”¨æˆ·ä¿¡æ¯ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
          this.isLoggingIn = false;
        });
    } catch (error) {
      hilog.error(LOG_DOMAIN, LOG_TAG, 'Context error: %{public}s', JSON.stringify(error));
      this.loginError = 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡è¯•';
      this.isLoggingIn = false;
    }
  }

  /** æ¨¡æ‹Ÿç™»å½•ï¼ˆä»…å¼€å‘æµ‹è¯•ï¼‰ */
  private onMockLogin(): void {
    if (!this.agreed || this.isLoggingIn) {
      return;
    }
    this.isLoggingIn = true;
    this.loginError = '';

    const context = getContext(this) as common.UIAbilityContext;
    const mockUser = AuthStore.createNewUser('mock_user_001', 'è½¨è¿¹ç”¨æˆ·', '');

    AuthStore.setUser(context, mockUser)
      .then(() => {
        router.replaceUrl({ url: 'pages/Main' });
      })
      .catch(() => {
        this.loginError = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        this.isLoggingIn = false;
      });
  }

  build() {
    Column() {
      Blank().layoutWeight(1);

      // ---- Logo å’Œæ ‡è¯­ ----
      Column({ space: 16 }) {
        Column() {
          Text('ðŸ—º')
            .fontSize(48);
        }
        .width(80)
        .height(80)
        .borderRadius(20)
        .backgroundColor($r('app.color.primary_light'))
        .justifyContent(FlexAlign.Center)
        .shadow({ radius: 12, color: '#1A3478F6', offsetX: 0, offsetY: 4 });

        Text('é¨æ¸¸è½¨è¿¹')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.label_primary'));
        Text('è®°å½•æ‰«å¢“è½¨è¿¹ï¼Œå®ˆæŠ¤å®¶æ—è®°å¿†')
          .fontSize(15)
          .fontColor($r('app.color.label_secondary'));
      }
      .alignItems(HorizontalAlign.Center);

      Blank().layoutWeight(1);

      // ---- åè®®å‹¾é€‰ + ç™»å½•æŒ‰é’® ----
      Column({ space: 20 }) {
        // åè®®å‹¾é€‰
        Row({ space: 6 }) {
          Checkbox()
            .select(this.agreed)
            .onChange((value: boolean) => {
              this.onAgreementChange(value);
            });
          Text('å·²é˜…è¯»å¹¶åŒæ„')
            .fontSize(13)
            .fontColor($r('app.color.label_secondary'));
          Text('ã€Šéšç§æ”¿ç­–ã€‹')
            .fontSize(13)
            .fontColor($r('app.color.link'))
            .onClick(() => {
              router.pushUrl({ url: 'pages/PrivacyPolicy' });
            });
          Text('ä¸Ž')
            .fontSize(13)
            .fontColor($r('app.color.label_secondary'));
          Text('ã€Šç”¨æˆ·åè®®ã€‹')
            .fontSize(13)
            .fontColor($r('app.color.link'))
            .onClick(() => {
              router.pushUrl({ url: 'pages/UserAgreement' });
            });
        }
        .width('100%')
        .justifyContent(FlexAlign.Center);

        // é”™è¯¯æç¤º
        if (this.loginError.length > 0) {
          Text(this.loginError)
            .fontSize(13)
            .fontColor($r('app.color.destructive'))
            .width('100%')
            .textAlign(TextAlign.Center);
        }

        // â˜… å®˜æ–¹åŽä¸ºè´¦å·ç™»å½•æŒ‰é’®ç»„ä»¶ï¼ˆä¸ªäººå¼€å‘è€…å¿…é¡»ä½¿ç”¨æ­¤ç»„ä»¶ï¼‰
        LoginWithHuaweiIDButton({
          params: {
            style: loginComponentManager.Style.BUTTON_RED,
            borderRadius: 24,
            loginType: loginComponentManager.LoginType.ID,
            supportDarkMode: true
          },
          controller: this.controller
        })
          .width('100%')
          .height(50);

        // å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•
        if (Config.IS_DEVELOPMENT_MODE) {
          Button('å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•')
            .width('100%')
            .height(40)
            .fontSize(14)
            .fontColor($r('app.color.label_secondary'))
            .backgroundColor(Color.Transparent)
            .borderRadius(20)
            .enabled(this.agreed && !this.isLoggingIn)
            .onClick(() => {
              this.onMockLogin();
            });
        }
      }
      .width('85%')
      .margin({ bottom: 48 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.login_background'));
  }
}
